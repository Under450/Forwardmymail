<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Portal - Forward My Mail</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 1200px;
      margin: 0 auto;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .content {
      padding: 40px;
    }

    .login-section, .portal-section {
      display: none;
    }

    .login-section.active, .portal-section.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1e3c72;
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .info-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .customer-selector {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .customer-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }

    .info-item {
      padding: 10px;
    }

    .info-label {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-value {
      color: #333;
      font-size: 18px;
      font-weight: 600;
    }

    .credit-value {
      color: #1e3c72;
      font-size: 24px;
    }

    .low-credit {
      color: #dc3545;
    }

    .scan-form {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .cost-display {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
    }

    .cost-amount {
      font-size: 32px;
      font-weight: bold;
      color: #1e3c72;
    }

    .logout-btn {
      background: #dc3545;
      margin-top: 20px;
    }

    .recent-activity {
      margin-top: 30px;
    }

    .activity-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .activity-info {
      flex: 1;
    }

    .activity-date {
      color: #666;
      font-size: 14px;
    }

    .activity-cost {
      font-weight: bold;
      color: #1e3c72;
    }

    .low-credit-warning {
      background: #fff3cd;
      border-left: 4px solid #ff9800;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      color: #856404;
    }

    .critical-credit-warning {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      color: #721c24;
    }

    .credit-value.low-credit {
      color: #ff9800 !important;
    }

    .credit-value.critical-credit {
      color: #dc3545 !important;
    }

    @media (max-width: 768px) {
      .customer-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè¢ Forward My Mail</h1>
      <p id="headerSubtitle">Staff Portal</p>
    </div>

    <div class="content">
      <!-- Login Section -->
      <div id="loginSection" class="login-section active">
        <h2 style="margin-bottom: 20px;">Staff Login</h2>
        <div id="errorMessage" class="error-message"></div>
        
        <form id="loginForm" autocomplete="off">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" required placeholder="staff@forwardmymail.co.uk" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required placeholder="Enter your password" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
          </div>
          
          <button type="submit" id="loginBtn">Login</button>
        </form>
      </div>

      <!-- Portal Section -->
      <div id="portalSection" class="portal-section">
        <div id="successMessage" class="success-message"></div>

        <!-- Customer Selector -->
        <div class="customer-selector">
          <h3 style="margin-bottom: 15px;">Select Customer</h3>
          <select id="customerSelect">
            <option value="">-- Select a customer --</option>
          </select>

          <div id="customerInfo" class="customer-info" style="display: none;">
            <div class="info-item">
              <div class="info-label">Customer Name</div>
              <div class="info-value" id="customerName">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Company</div>
              <div class="info-value" id="customerCompany">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value" id="customerEmail">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Credit Balance</div>
              <div class="info-value credit-value" id="customerCredits">¬£0.00</div>
            </div>
          </div>
        </div>

        <!-- Low Credit Warning -->
        <div id="lowCreditWarning" style="display: none;"></div>

        <!-- Scan Processing Form -->
        <div class="scan-form" id="scanForm" style="display: none;">
          <h3 style="margin-bottom: 20px;">Process Mail Scan</h3>
          
          <div class="form-group">
            <label for="pages">Number of Pages</label>
            <input type="number" id="pages" min="1" value="1" required>
          </div>

          <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea id="notes" rows="3" placeholder="Add any notes about this scan..."></textarea>
          </div>

          <div class="cost-display">
            <div style="color: #666; margin-bottom: 5px;">Estimated Cost</div>
            <div class="cost-amount">¬£<span id="costAmount">0.50</span></div>
            <div style="color: #666; margin-top: 5px; font-size: 14px;">
              First page: ¬£0.50 | Additional: ¬£0.25/page
            </div>
          </div>

          <button id="processScanBtn" style="width: 100%; margin-top: 20px;">Process Scan</button>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity" id="recentActivity" style="display: none;">
          <h3 style="margin-bottom: 15px;">Recent Activity</h3>
          <div id="activityList">
            <p style="color: #666; text-align: center; padding: 20px;">No recent activity</p>
          </div>
        </div>

        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit, updateDoc, addDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCToSDWiFy0zjDo4Amfe4_IV8z7N54jrQU",
      authDomain: "forward-my-mail.firebaseapp.com",
      projectId: "forward-my-mail",
      storageBucket: "forward-my-mail.firebasestorage.app",
      messagingSenderId: "933044287958",
      appId: "1:933044287958:web:fa3a707dbec62b24e74c77",
      measurementId: "G-J8M65WQCGH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM Elements
    const loginSection = document.getElementById('loginSection');
    const portalSection = document.getElementById('portalSection');
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const customerSelect = document.getElementById('customerSelect');
    const customerInfo = document.getElementById('customerInfo');
    const scanForm = document.getElementById('scanForm');
    const recentActivity = document.getElementById('recentActivity');
    const pagesInput = document.getElementById('pages');
    const costAmount = document.getElementById('costAmount');
    const processScanBtn = document.getElementById('processScanBtn');

    let currentCustomer = null;
    let unsubscribeCustomer = null;

    // Force clear login fields on page load (prevent autofill)
    window.addEventListener('load', () => {
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Wait for ID token to be ready
        try {
          await user.getIdToken(true);
          await loadCustomers();
          loginSection.classList.remove('active');
          portalSection.classList.add('active');
        } catch (error) {
          console.error('Error getting auth token:', error);
          showError('Authentication error. Please try logging in again.');
        }
      } else {
        loginSection.classList.add('active');
        portalSection.classList.remove('active');
        if (unsubscribeCustomer) unsubscribeCustomer();
      }
    });

    // Login form handler
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        showError('Invalid email or password');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    // Logout handler
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        showError('Error logging out');
      }
    });

    // Load customers
    async function loadCustomers() {
      try {
        const querySnapshot = await getDocs(collection(db, 'customers'));
        
        customerSelect.innerHTML = '<option value="">-- Select a customer --</option>';
        
        querySnapshot.forEach((doc) => {
          const customer = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${customer.name} - ${customer.company || 'No company'}`;
          customerSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading customers:', error);
        showError('Error loading customers');
      }
    }

    // Customer select handler
    customerSelect.addEventListener('change', async (e) => {
      const customerId = e.target.value;
      
      if (!customerId) {
        customerInfo.style.display = 'none';
        scanForm.style.display = 'none';
        recentActivity.style.display = 'none';
        currentCustomer = null;
        if (unsubscribeCustomer) unsubscribeCustomer();
        return;
      }

      try {
        const customerDoc = await getDoc(doc(db, 'customers', customerId));
        
        if (customerDoc.exists()) {
          currentCustomer = { id: customerId, ...customerDoc.data() };
          displayCustomerInfo(currentCustomer);
          scanForm.style.display = 'block';
          recentActivity.style.display = 'block';
          await loadRecentActivity(customerId);

          // Listen for real-time credit updates
          if (unsubscribeCustomer) unsubscribeCustomer();
          unsubscribeCustomer = onSnapshot(doc(db, 'customers', customerId), (doc) => {
            if (doc.exists()) {
              currentCustomer = { id: customerId, ...doc.data() };
              displayCustomerInfo(currentCustomer);
            }
          });
        }
      } catch (error) {
        console.error('Error loading customer:', error);
        showError('Error loading customer details');
      }
    });

    // Display customer info
    function displayCustomerInfo(customer) {
      document.getElementById('customerName').textContent = customer.name || '-';
      document.getElementById('customerCompany').textContent = customer.company || '-';
      document.getElementById('customerEmail').textContent = customer.email || '-';
      
      const credits = customer.credits || 0;
      const creditsElement = document.getElementById('customerCredits');
      const warningElement = document.getElementById('lowCreditWarning');
      creditsElement.textContent = `¬£${credits.toFixed(2)}`;
      
      // Remove all credit classes first
      creditsElement.classList.remove('low-credit', 'critical-credit');
      
      // Show appropriate warning based on credit level
      if (credits < 0.50) {
        // CRITICAL - Can't process any scans
        creditsElement.classList.add('critical-credit');
        warningElement.className = 'critical-credit-warning';
        warningElement.innerHTML = '‚õî <strong>CRITICAL:</strong> Customer has insufficient credits (¬£' + credits.toFixed(2) + '). Minimum ¬£0.50 required to process scans. Customer must purchase credits before processing.';
        warningElement.style.display = 'block';
      } else if (credits < 2.00) {
        // LOW - Can process 1-3 scans only
        const scansRemaining = Math.floor((credits - 0.50) / 0.25) + 1;
        creditsElement.classList.add('low-credit');
        warningElement.className = 'low-credit-warning';
        warningElement.innerHTML = '‚ö†Ô∏è <strong>LOW CREDITS:</strong> Customer has ¬£' + credits.toFixed(2) + ' remaining (approximately ' + scansRemaining + ' scan(s)). Advise customer to purchase more credits soon.';
        warningElement.style.display = 'block';
      } else if (credits < 5.00) {
        // MODERATE - Show gentle warning
        creditsElement.classList.add('low-credit');
        warningElement.className = 'low-credit-warning';
        warningElement.innerHTML = 'üí° <strong>NOTICE:</strong> Customer credit balance is getting low (¬£' + credits.toFixed(2) + '). Consider notifying customer.';
        warningElement.style.display = 'block';
      } else {
        // SUFFICIENT - No warning
        warningElement.style.display = 'none';
      }

      customerInfo.style.display = 'grid';
    }

    // Calculate cost
    pagesInput.addEventListener('input', () => {
      const pages = parseInt(pagesInput.value) || 1;
      const cost = 0.50 + ((pages - 1) * 0.25);
      costAmount.textContent = cost.toFixed(2);
    });

    // Process scan handler
    processScanBtn.addEventListener('click', async () => {
      if (!currentCustomer) {
        showError('Please select a customer first');
        return;
      }

      const pages = parseInt(pagesInput.value) || 1;
      const notes = document.getElementById('notes').value;
      const cost = 0.50 + ((pages - 1) * 0.25);

      if (currentCustomer.credits < cost) {
        showError(`Insufficient credits. Need ¬£${cost.toFixed(2)}, but customer only has ¬£${currentCustomer.credits.toFixed(2)}`);
        return;
      }

      try {
        processScanBtn.disabled = true;
        processScanBtn.textContent = 'Processing...';

        // Create mail item record
        await addDoc(collection(db, 'mailItems'), {
          customerId: currentCustomer.id,
          pages: pages,
          cost: cost,
          notes: notes,
          processedAt: serverTimestamp(),
          processedBy: auth.currentUser.email,
          status: 'scanned'
        });

        // Deduct credits
        const newCredits = currentCustomer.credits - cost;
        await updateDoc(doc(db, 'customers', currentCustomer.id), {
          credits: newCredits
        });

        showSuccess(`Scan processed successfully! ${pages} page(s) - ¬£${cost.toFixed(2)} deducted. New balance: ¬£${newCredits.toFixed(2)}`);
        
        // Reset form
        pagesInput.value = 1;
        document.getElementById('notes').value = '';
        costAmount.textContent = '0.50';

        // Reload activity
        await loadRecentActivity(currentCustomer.id);

      } catch (error) {
        console.error('Error processing scan:', error);
        showError('Error processing scan. Please try again.');
      } finally {
        processScanBtn.disabled = false;
        processScanBtn.textContent = 'Process Scan';
      }
    });

    // Load recent activity
    async function loadRecentActivity(customerId) {
      try {
        const q = query(
          collection(db, 'mailItems'),
          where('customerId', '==', customerId),
          orderBy('processedAt', 'desc'),
          limit(10)
        );

        const querySnapshot = await getDocs(q);
        const activityList = document.getElementById('activityList');
        
        if (querySnapshot.empty) {
          activityList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No recent activity</p>';
          return;
        }

        let html = '';
        querySnapshot.forEach((doc) => {
          const item = doc.data();
          const date = item.processedAt?.toDate().toLocaleString() || 'Unknown';
          
          html += `
            <div class="activity-item">
              <div class="activity-info">
                <div><strong>${item.pages} page(s)</strong></div>
                <div class="activity-date">${date}</div>
                ${item.notes ? `<div style="color: #666; font-size: 14px; margin-top: 5px;">${item.notes}</div>` : ''}
              </div>
              <div class="activity-cost">-¬£${item.cost.toFixed(2)}</div>
            </div>
          `;
        });

        activityList.innerHTML = html;
      } catch (error) {
        console.error('Error loading activity:', error);
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => errorMessage.classList.remove('show'), 5000);
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('show');
      setTimeout(() => successMessage.classList.remove('show'), 5000);
    }
  </script>
</body>
</html>
