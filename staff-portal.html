<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Staff Portal - Forward My Mail</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      min-height:100vh; padding:20px;
    }
    .container{background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:1200px;margin:0 auto;overflow:hidden;}
    .header{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#fff;padding:30px;text-align:center;}
    .header .logo{width:120px;height:auto;margin-bottom:15px;filter:brightness(0) invert(1);}
    .header h1{font-size:28px;margin-bottom:10px;}
    .content{padding:40px;}
    .login-section,.portal-section{display:none;}
    .login-section.active,.portal-section.active{display:block;}
    .form-group{margin-bottom:20px;}
    label{display:block;margin-bottom:8px;color:#333;font-weight:500;}
    input,select,textarea{
      width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:16px;transition:border-color .3s;
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:#1e3c72;}
    #letterType option[disabled]{color:#bbb;}
    button{
      padding:12px 24px;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:transform .2s;
    }
    button:hover{transform:translateY(-2px);} button:active{transform:translateY(0);} button:disabled{opacity:.6;cursor:not-allowed;}
    .error-message{background:#fee;color:#c33;padding:12px;border-radius:8px;margin-bottom:20px;display:none;}
    .error-message.show{display:block;}
    .success-message{background:#efe;color:#3c3;padding:12px;border-radius:8px;margin-bottom:20px;display:none;}
    .success-message.show{display:block;}
    .info-card{background:#f8f9fa;border-radius:12px;padding:20px;margin-bottom:20px;}
    .customer-selector{margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:12px;}
    .grid{display:grid;gap:15px;}
    .customer-info{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin-top:20px;padding:20px;background:#fff;border-radius:8px;}
    .info-item{padding:10px;}
    .info-label{color:#666;font-size:14px;margin-bottom:5px;}
    .info-value{color:#333;font-size:18px;font-weight:600;}
    .credit-value{color:#1e3c72;font-size:24px;}
    .credit-value.low-credit{color:#ff9800!important;}
    .credit-value.critical-credit{color:#dc3545!important;}
    .low-credit-warning{background:#fff3cd;border-left:4px solid #ff9800;padding:15px;border-radius:8px;margin-bottom:20px;font-weight:500;color:#856404;}
    .critical-credit-warning{background:#f8d7da;border-left:4px solid #dc3545;padding:15px;border-radius:8px;margin-bottom:20px;font-weight:500;color:#721c24;}
    .panel{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:20px;margin-bottom:20px;}
    .panel h3{margin-bottom:12px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .row>*{flex:1 1 200px;}

    .scan-form .cost-display{background:#e7f3ff;padding:15px;border-radius:8px;margin-top:15px;text-align:center;}
    .cost-amount{font-size:32px;font-weight:bold;color:#1e3c72;}
    .recent-activity{margin-top:30px;}
    .activity-item{background:#fff;border:1px solid #e0e0e0;border-radius:8px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .activity-info{flex:1;}
    .activity-date{color:#666;font-size:14px;}
    .activity-cost{font-weight:bold;color:#1e3c72;white-space:nowrap;}
    .delete-btn{background:#e74c3c;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;}
    .pkg-badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #e0e0e0;font-size:14px;font-weight:600;color:#1e3c72;background:#f7f9ff;white-space:nowrap;}

    /* custom Choose Files button */
    .file-picker{display:flex;align-items:center;justify-content:center;gap:12px;margin-top:6px;}
    .btn-file{display:inline-block;padding:12px 20px;background:#ff8a00;color:#fff;font-weight:700;border-radius:8px;cursor:pointer;user-select:none;border:2px solid #ff8a00;box-shadow:0 2px 6px rgba(0,0,0,.12);transition:transform .12s, background .12s, border-color .12s;}
    .btn-file:hover{transform:translateY(-1px);background:#ff7a00;border-color:#ff7a00;}
    .btn-file:active{transform:translateY(0);}
    .file-status{color:#666;font-size:14px;}
    #scanFiles{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;clip-path:inset(50%);border:0;padding:0;margin:-1px;}

    @media (max-width:768px){ .customer-info{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.forwardmymail.co.uk/logo.png" alt="Forward My Mail" class="logo"/>
      <h1>Forward My Mail</h1>
      <p id="headerSubtitle">Staff Portal</p>
    </div>

    <div class="content">
      <!-- Login -->
      <div id="loginSection" class="login-section active">
        <h2 style="margin-bottom:20px;">Staff Login</h2>
        <div id="errorMessage" class="error-message"></div>
        <form id="loginForm" autocomplete="off">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" required placeholder="staff@forwardmymail.co.uk" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required placeholder="Enter your password" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
          <button type="submit" id="loginBtn">Login</button>
        </form>
        <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0;">
          <p style="color:#666;"><a href="reset-password.html" style="color:#1e3c72;text-decoration:none;font-weight:500;">Forgot password?</a></p>
        </div>
      </div>

      <!-- Portal -->
      <div id="portalSection" class="portal-section">
        <div id="successMessage" class="success-message"></div>

        <!-- Customer selector -->
        <div class="customer-selector panel">
          <h3 style="margin-bottom:15px;">Select Customer</h3>
          <select id="customerSelect"><option value="">-- Select a customer --</option></select>

          <div id="customerInfo" class="customer-info grid" style="display:none;">
            <div class="info-item"><div class="info-label">Customer Name</div><div class="info-value" id="customerName">-</div></div>
            <div class="info-item"><div class="info-label">Company</div><div class="info-value" id="customerCompany">-</div></div>
            <div class="info-item"><div class="info-label">Email</div><div class="info-value" id="customerEmail">-</div></div>
            <div class="info-item"><div class="info-label">Mailbox ID</div><div class="info-value" id="customerMailboxId">-</div></div>
            <div class="info-item"><div class="info-label">Package</div><div class="info-value"><span id="customerPackage" class="pkg-badge">-</span></div></div>
            <div class="info-item"><div class="info-label">Credit Balance</div><div class="info-value credit-value" id="customerCredits">¬£0.00</div></div>
            <div class="info-item"><div class="info-label">Free scans left (this month)</div><div class="info-value" id="customerFreeScans">0</div></div>
          </div>

          <div id="lowCreditWarning" style="display:none;"></div>
        </div>

        <!-- ID Verification controls -->
        <div class="panel" id="idPanel" style="display:none;">
          <h3>ID Verification</h3>
          <div class="row">
            <div>
              <label for="idStatus">Status</label>
              <select id="idStatus">
  <option value="pending">Pending</option>
  <option value="verified">Verified</option>
  <option value="rejected">Rejected</option>
</select>
            </div>
            <div>
              <label for="idRequired">Require ID check to use portal</label>
              <select id="idRequired">
                <option value="true">Yes (block portal)</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="saveIdBtn" type="button">Save ID settings</button>
          </div>
          <div id="idNote" style="margin-top:10px;color:#666;font-size:14px;"></div>
        </div>

        <!-- Free Scans settings -->
        <div class="panel" id="freeScansPanel" style="display:none;">
          <h3>Free Scans</h3>
          <div class="row" style="align-items:end;margin-top:10px;">
            <div>
              <label>One-off grant</label>
              <button id="addFreeScanBtn" type="button">Add 1 Free Scan</button>
            </div>
          </div>
          <div class="info-card" style="margin-top:15px;">
            <div class="row">
              <div><label for="monthlyFreeAllowance">Monthly allowance (scans)</label><input type="number" id="monthlyFreeAllowance" min="0" value="0"/></div>
              <div><label for="resetMode">Renewal behavior</label>
                <select id="resetMode">
                  <option value="reset">Reset to allowance each month</option>
                  <option value="topup">Top-up (add) allowance each month</option>
                </select>
              </div>
              <div style="display:flex;align-items:center;">
                <input type="checkbox" id="autoRenewFreeScans" style="width:20px;height:20px;margin-right:10px;"/>
                <label for="autoRenewFreeScans" style="margin:0;">Auto-renew monthly</label>
              </div>
            </div>
            <div class="row" style="margin-top:12px;">
              <button id="saveFreeScanSettingsBtn" type="button">Save settings</button>
              <button id="applyMonthlyNowBtn" type="button" style="background:#1f7a1f;">Apply allowance now</button>
            </div>
          </div>
        </div>

        <!-- Scan form -->
        <div class="scan-form panel" id="scanForm" style="display:none;">
          <h3 style="margin-bottom:20px;">Process Mail Scan</h3>

          <div class="form-group">
            <label for="letterType">Type of letter</label>
            <select id="letterType">
              <option value="personal">Personal</option>
              <option value="company">Company</option>
              <option value="hmrc">HMRC</option>
              <option value="companies-house">Companies House</option>
              <option value="override">Override (allow anyway)</option>
            </select>
            <div id="letterTypeHelp" style="font-size:13px;color:#666;margin-top:6px;"></div>
          </div>

          <div class="form-group"><label for="pages">Number of Pages</label><input type="number" id="pages" min="1" value="1" required/></div>
          <div class="form-group"><label for="notes">Notes (Optional)</label><textarea id="notes" rows="3" placeholder="Add any notes about this scan..."></textarea></div>

          <div class="form-group">
            <label>Upload Scanned Documents</label>
            <input type="file" id="scanFiles" multiple accept="image/*,.pdf"/>
            <div class="file-picker" aria-live="polite">
              <label for="scanFiles" class="btn-file" role="button" tabindex="0">Choose Files</label>
              <span id="fileStatus" class="file-status">No file chosen</span>
            </div>
            <div style="font-size:13px;color:#666;margin-top:8px;">Select one or more images (JPG, PNG) or PDF files</div>
            <div id="fileList" style="margin-top:10px;font-size:14px;color:#666;"></div>
            <div id="uploadProgress" style="display:none;margin-top:10px;">
              <div style="background:#e0e0e0;height:20px;border-radius:10px;overflow:hidden;">
                <div id="progressBar" style="background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);height:100%;width:0%;transition:width .3s;"></div>
              </div>
              <div id="progressText" style="text-align:center;margin-top:5px;font-size:13px;color:#666;"></div>
            </div>
          </div>

          <div class="cost-display">
            <div style="color:#666;margin-bottom:5px;">Estimated Cost</div>
            <div class="cost-amount">¬£<span id="costAmount">0.50</span></div>
            <div style="color:#666;margin-top:5px;font-size:14px;">First page: ¬£0.50 | Additional: ¬£0.25/page</div>
          </div>

          <button id="processScanBtn" style="width:100%;margin-top:20px;">Process Scan</button>
        </div>

        <div class="recent-activity" id="recentActivity" style="display:none;">
          <h3 style="margin-bottom:15px;">Recent Activity</h3>
          <div id="activityList"><p style="color:#666;text-align:center;padding:20px;">No recent activity</p></div>
        </div>

        <button id="logoutBtn" class="logout-btn" style="margin-top:20px;">Logout</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
   import {
  getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit,
  updateDoc, addDoc, onSnapshot, serverTimestamp, increment, Timestamp, deleteDoc, deleteField
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCToSDWiFy0zjDo4Amfe4_IV8z7N54jrQU",
      authDomain: "forward-my-mail.firebaseapp.com",
      projectId: "forward-my-mail",
      storageBucket: "forward-my-mail.firebasestorage.app",
      messagingSenderId: "933044287958",
      appId: "1:933044287958:web:fa3a707dbec62b24e74c77",
      measurementId: "G-J8M65WQCGH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginSection = document.getElementById('loginSection');
    const portalSection = document.getElementById('portalSection');
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    const customerSelect = document.getElementById('customerSelect');
    const customerInfo = document.getElementById('customerInfo');
    const scanForm = document.getElementById('scanForm');
    const recentActivity = document.getElementById('recentActivity');

    const pagesInput = document.getElementById('pages');
    const costAmount = document.getElementById('costAmount');
    const processScanBtn = document.getElementById('processScanBtn');

    const scanFilesInput = document.getElementById('scanFiles');
    const fileListDiv = document.getElementById('fileList');
    const uploadProgressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const fileStatus = document.getElementById('fileStatus');

    const addFreeScanBtn = document.getElementById('addFreeScanBtn');
    const customerFreeScansEl = document.getElementById('customerFreeScans');
    const freeScansPanel = document.getElementById('freeScansPanel');

    const monthlyFreeAllowanceInput = document.getElementById('monthlyFreeAllowance');
    const autoRenewFreeScansInput = document.getElementById('autoRenewFreeScans');
    const resetModeSelect = document.getElementById('resetMode');
    const saveFreeScanSettingsBtn = document.getElementById('saveFreeScanSettingsBtn');
    const applyMonthlyNowBtn = document.getElementById('applyMonthlyNowBtn');

    const lowCreditWarning = document.getElementById('lowCreditWarning');

    const letterType = document.getElementById('letterType');
    const letterTypeHelp = document.getElementById('letterTypeHelp');

    const customerPackageEl = document.getElementById('customerPackage');
    const customerMailboxIdEl = document.getElementById('customerMailboxId');

    // ID panel refs
    const idPanel = document.getElementById('idPanel');
    const idStatusSel = document.getElementById('idStatus');
    const idRequiredSel = document.getElementById('idRequired');
    const idNote = document.getElementById('idNote');
    const saveIdBtn = document.getElementById('saveIdBtn');

    let currentCustomer = null;
    let unsubscribeCustomer = null;

    // prevent autofill
    window.addEventListener('load', () => {
      const e = document.getElementById('email');
      const p = document.getElementById('password');
      if (e) e.value = ''; if (p) p.value = '';
    });

    function showError(msg){ errorMessage.textContent = msg; errorMessage.classList.add('show'); setTimeout(()=>errorMessage.classList.remove('show'), 5000); }
    function showSuccess(msg){ successMessage.textContent = msg; successMessage.classList.add('show'); setTimeout(()=>successMessage.classList.remove('show'), 5000); }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          await user.getIdToken(true);
          await loadCustomers();
          loginSection.classList.remove('active');
          portalSection.classList.add('active');
        } catch (err) {
          console.error('Auth error:', err);
          showError('Authentication error. Please try logging in again.');
        }
      } else {
        loginSection.classList.add('active');
        portalSection.classList.remove('active');
        if (unsubscribeCustomer) unsubscribeCustomer();
        currentCustomer = null;
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        loginBtn.disabled = true; loginBtn.textContent='Logging in...';
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error){ showError('Invalid email or password'); }
      finally { loginBtn.disabled = false; loginBtn.textContent='Login'; }
    });

    logoutBtn.addEventListener('click', async () => { try{ await signOut(auth); }catch(e){ showError('Error logging out'); } });

    async function loadCustomers(){
      const qs = await getDocs(collection(db,'customers'));
      customerSelect.innerHTML = '<option value="">-- Select a customer --</option>';
      qs.forEach(d=>{
        const c = d.data();
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = `${c.name || 'Unnamed'} ‚Äî ${c.company || 'No company'}`;
        customerSelect.appendChild(opt);
      });
    }

    function allowedTypesForPackage(pkg){
      const p = (pkg||'').toUpperCase().trim();
      if (p === 'BUSINESS ADDRESS') return ['personal','company','override'];
      if (p === 'REGISTERED OFFICE' || p === 'FULL VIRTUAL OFFICE' || p === 'REGISTERED AND FULL VIRTUAL OFFICE')
        return ['hmrc','companies-house','personal','override'];
      return ['personal','override']; // default PERSONAL MAILBOX
    }
    function refreshLetterTypeOptions(packageType){
      const allowed = new Set(allowedTypesForPackage(packageType));
      Array.from(letterType.options).forEach(opt => { opt.disabled = !allowed.has(opt.value); });
      const firstAllowed = Array.from(letterType.options).find(o=>!o.disabled);
      if (firstAllowed) letterType.value = firstAllowed.value;
      const pkg = packageType || 'PERSONAL MAILBOX';
      const unavailable = Array.from(letterType.options).filter(o=>o.disabled).map(o=>o.textContent).join(', ');
      letterTypeHelp.textContent = unavailable ? `Package: ${pkg}. Unavailable types (greyed out): ${unavailable}. Use ‚ÄúOverride‚Äù only with approval.` : `Package: ${pkg}.`;
    }

    customerSelect.addEventListener('change', async (e)=>{
      const id = e.target.value;
      if (!id){ hideCustomerPanels(); return; }
      const snap = await getDoc(doc(db,'customers', id));
      if (!snap.exists()){ hideCustomerPanels(); return; }
      currentCustomer = { id, ...snap.data() };
      renderCustomer(currentCustomer);
      scanForm.style.display='block';
      recentActivity.style.display='block';
      freeScansPanel.style.display='block';
      idPanel.style.display='block';
      await loadRecentActivity(id);

      if (unsubscribeCustomer) unsubscribeCustomer();
      unsubscribeCustomer = onSnapshot(doc(db,'customers', id), live=>{
        if (!live.exists()) return;
        currentCustomer = { id, ...live.data() };
        renderCustomer(currentCustomer);
      });
    });

    function hideCustomerPanels(){
      customerInfo.style.display='none';
      scanForm.style.display='none';
      recentActivity.style.display='none';
      freeScansPanel.style.display='none';
      idPanel.style.display='none';
      lowCreditWarning.style.display='none';
      currentCustomer = null;
      if (unsubscribeCustomer) unsubscribeCustomer();
    }

    function tsToDate(ts){
      try {
        if (!ts) return null;
        if (typeof ts.toDate === 'function') return ts.toDate();
        return new Date(ts);
      } catch { return null; }
    }

    function renderCustomer(cust){
      document.getElementById('customerName').textContent = cust.name || '-';
      document.getElementById('customerCompany').textContent = cust.company || '-';
      document.getElementById('customerEmail').textContent = cust.email || '-';
      customerMailboxIdEl.textContent = cust.mailboxId || '-';
      customerPackageEl.textContent = (cust.packageType || 'Not set').toString();

      const credits = Number(cust.credits || 0);
      const freeScans = Number(cust.freeScansRemaining || 0);
      const creditsEl = document.getElementById('customerCredits');
      creditsEl.textContent = `¬£${credits.toFixed(2)}`;
      creditsEl.classList.remove('low-credit','critical-credit');
      if (credits < 0.50 && freeScans <= 0) creditsEl.classList.add('critical-credit');
      else if (credits < 5.00) creditsEl.classList.add('low-credit');

      if (customerFreeScansEl) customerFreeScansEl.textContent = String(freeScans);

      if (credits < 0.50 && freeScans <= 0){
        lowCreditWarning.className='critical-credit-warning';
        lowCreditWarning.innerHTML='‚õî <strong>CRITICAL:</strong> Insufficient credits and no free scans.';
        lowCreditWarning.style.display='block';
      } else if (freeScans > 0){
        lowCreditWarning.className='low-credit-warning';
        lowCreditWarning.innerHTML=`‚úÖ <strong>Free scans available:</strong> ${freeScans} left this month.`;
        lowCreditWarning.style.display='block';
      } else if (credits < 5){
        lowCreditWarning.className='low-credit-warning';
        lowCreditWarning.innerHTML=`‚ö†Ô∏è <strong>LOW CREDITS:</strong> ¬£${credits.toFixed(2)} remaining.`;
        lowCreditWarning.style.display='block';
      } else {
        lowCreditWarning.style.display='none';
      }

      monthlyFreeAllowanceInput.value = Number(cust.monthlyFreeAllowance ?? 0);
      autoRenewFreeScansInput.checked = Boolean(cust.autoRenewFreeScans);
      resetModeSelect.value = (cust.resetMode || 'reset').toLowerCase();

      refreshLetterTypeOptions(cust.packageType || 'PERSONAL MAILBOX');
      customerInfo.style.display='grid';

      // ID panel values
      idStatusSel.value = String(cust.idStatus || 'pending');
      idRequiredSel.value = String(Boolean(cust.idGate));
      const lastUpd = tsToDate(cust.idStatusUpdatedAt);
      idNote.textContent = lastUpd ? `Last updated: ${lastUpd.toLocaleString()}` : '';
    }

   // Save ID settings
saveIdBtn.addEventListener('click', async ()=>{
  if (!currentCustomer?.id) return showError('Select a customer first');
  try{
    saveIdBtn.disabled = true;
    await updateDoc(doc(db,'customers', currentCustomer.id), {
      idStatus: idStatusSel.value,
      idGate: idRequiredSel.value === 'true',  // ‚Üê Should say idGate
      idRequired: deleteField(), 
      idStatusUpdatedAt: serverTimestamp(),
      idUpdatedBy: auth.currentUser?.email || 'staff'
    });
    showSuccess('ID settings saved');
  }catch(e){ showError('Failed to save ID settings: ' + (e?.message||e)); }
  finally{ saveIdBtn.disabled = false; }
});

    // Free scans quick add
    addFreeScanBtn?.addEventListener('click', async ()=>{
      if (!currentCustomer?.id) return showError('Select a customer first');
      try{
        addFreeScanBtn.disabled = true;
        await updateDoc(doc(db,'customers', currentCustomer.id), { freeScansRemaining: increment(1) });
        showSuccess('Added 1 free scan');
      }catch(e){ showError('Failed to add free scan: ' + e.message); }
      finally{ addFreeScanBtn.disabled = false; }
    });

    // Save free scan settings
    saveFreeScanSettingsBtn.addEventListener('click', async ()=>{
      if (!currentCustomer?.id) return showError('Select a customer first');
      const allowance = Math.max(Number(monthlyFreeAllowanceInput.value || 0), 0);
      const autoRenew = Boolean(autoRenewFreeScansInput.checked);
      const resetMode = resetModeSelect.value === 'topup' ? 'topup' : 'reset';
      try{
        saveFreeScanSettingsBtn.disabled = true;
        await updateDoc(doc(db,'customers', currentCustomer.id), {
          monthlyFreeAllowance: allowance, autoRenewFreeScans: autoRenew, resetMode
        });
        showSuccess('Free scan settings saved');
      }catch(e){ showError('Failed to save settings: ' + e.message); }
      finally{ saveFreeScanSettingsBtn.disabled = false; }
    });

    // Apply allowance now
    applyMonthlyNowBtn.addEventListener('click', async ()=>{
      if (!currentCustomer?.id) return showError('Select a customer first');
      const allowance = Math.max(Number(monthlyFreeAllowanceInput.value || 0), 0);
      const resetMode = resetModeSelect.value === 'topup' ? 'topup' : 'reset';
      if (allowance <= 0) return showError('Monthly allowance must be greater than 0 to apply');
      try{
        applyMonthlyNowBtn.disabled = true;
        const tzNow = new Date(new Date().toLocaleString('en-GB',{ timeZone:'Europe/London' }));
        const y = tzNow.getFullYear(); const m = String(tzNow.getMonth()+1).padStart(2,'0');
        const currentMonthKey = `${y}-${m}`;

        if (resetMode === 'topup'){
          await updateDoc(doc(db,'customers', currentCustomer.id), {
            freeScansRemaining: increment(allowance),
            lastAppliedMonthKey: currentMonthKey, applyAtMonthKey: null
          });
        } else {
          await updateDoc(doc(db,'customers', currentCustomer.id), {
            freeScansRemaining: allowance,
            lastAppliedMonthKey: currentMonthKey, applyAtMonthKey: null
          });
        }
        showSuccess('Monthly allowance applied');
      }catch(e){ showError('Failed to apply allowance: ' + e.message); }
      finally{ applyMonthlyNowBtn.disabled = false; }
    });

    // Cost estimate
    pagesInput.addEventListener('input', ()=>{
      const pages = Math.max(parseInt(pagesInput.value)||1,1);
      const cost = 0.50 + ((pages - 1) * 0.25);
      costAmount.textContent = cost.toFixed(2);
    });

    // File status preview
    scanFilesInput.addEventListener('change',(e)=>{
      const files = Array.from(e.target.files || []);
      if (!files.length){ fileListDiv.innerHTML=''; if (fileStatus) fileStatus.textContent='No file chosen'; return; }
      const rows = files.map((f,i)=>`${i+1}. ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`);
      fileListDiv.innerHTML = `<strong>${files.length} file(s) selected:</strong><br>${rows.join('<br>')}`;
      if (fileStatus) fileStatus.textContent = files.length===1 ? files[0].name : `${files.length} files selected`;
    });

    async function uploadScanFiles(customerId, files){
      const uploaded=[]; const ts=Date.now();
      for (let i=0;i<files.length;i++){
        const file = files[i];
        const name = `${ts}_${i+1}_${file.name}`;
        const storageRef = ref(storage, `mail-scans/${customerId}/${name}`);
        progressText.textContent = `Uploading ${i+1} of ${files.length}: ${file.name}`;
        const task = uploadBytesResumable(storageRef, file);
        await new Promise((resolve,reject)=>{
          task.on('state_changed',
            snap=>{
              const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
              const overall = ((i/files.length) + (pct/100/files.length)) * 100;
              progressBar.style.width = overall + '%';
            },
            err=>reject(err),
            async ()=>{
              const url = await getDownloadURL(task.snapshot.ref);
              uploaded.push({ name:file.name, url, size:file.size, type:file.type });
              resolve();
            }
          );
        });
      }
      return uploaded;
    }

    // Process scan
    processScanBtn.addEventListener('click', async ()=>{
      if (!currentCustomer?.id) return showError('Please select a customer first');
      const pages = Math.max(parseInt(pagesInput.value)||1,1);
      const notes = document.getElementById('notes').value || '';
      const baseCost = 0.50 + ((pages - 1) * 0.25);
      const files = Array.from(scanFilesInput.files || []);

      // enforce letter type rules + override
      const selectedType = letterType.value;
      const selectedOpt = letterType.options[letterType.selectedIndex];
      if (selectedOpt.disabled && selectedType !== 'override'){ return showError('This letter type is not included in the customer‚Äôs package. Use ‚ÄúOverride‚Äù if approved.'); }
      if (selectedType === 'override'){ const ok = confirm('Use Override for this scan?'); if (!ok) return; }

      const freeScans = Number(currentCustomer.freeScansRemaining || 0);
      let usedFreeScan = false; let payable = baseCost;
      if (freeScans > 0){ usedFreeScan = true; payable = 0; }
      else if ((currentCustomer.credits || 0) < baseCost){ return showError(`Insufficient credits. Need ¬£${baseCost.toFixed(2)}.`); }

      try{
        processScanBtn.disabled = true; processScanBtn.textContent='Processing...';

        let uploadedFiles = [];
        if (files.length){ uploadProgressDiv.style.display='block'; uploadedFiles = await uploadScanFiles(currentCustomer.id, files); uploadProgressDiv.style.display='none'; }

        await addDoc(collection(db,'mailItems'), {
          customerId: currentCustomer.id,
          pages, cost: payable, notes,
          files: uploadedFiles,
          processedAt: serverTimestamp(),
          processedBy: auth.currentUser?.email || 'staff',
          status: 'scanned',
          freeScanUsed: usedFreeScan,
          ttlAt: Timestamp.fromDate(new Date(Date.now() + 30*24*60*60*1000)),
          letterType: selectedType
        });

        if (usedFreeScan){
          await updateDoc(doc(db,'customers', currentCustomer.id), { freeScansRemaining: increment(-1) });
          currentCustomer.freeScansRemaining = Math.max((currentCustomer.freeScansRemaining||0)-1, 0);
        } else {
          const newCredits = (currentCustomer.credits || 0) - baseCost;
          await updateDoc(doc(db,'customers', currentCustomer.id), { credits: newCredits });
          currentCustomer.credits = newCredits;
        }

        renderCustomer(currentCustomer);
        showSuccess(`Scan processed: ${pages} page(s) ‚Äî ${usedFreeScan ? 'free' : '¬£'+baseCost.toFixed(2)+' deducted'}.`);

        pagesInput.value=1; document.getElementById('notes').value='';
        scanFilesInput.value=''; fileListDiv.innerHTML=''; if (fileStatus) fileStatus.textContent='No file chosen';
        costAmount.textContent='0.50'; progressBar.style.width='0%';
        await loadRecentActivity(currentCustomer.id);
      }catch(e){
        console.error('process scan error:', e);
        showError('Error processing scan: ' + e.message);
        uploadProgressDiv.style.display='none';
      }finally{
        processScanBtn.disabled=false; processScanBtn.textContent='Process Scan';
      }
    });

    async function loadRecentActivity(customerId){
      const qy = query(collection(db,'mailItems'), where('customerId','==', customerId), orderBy('processedAt','desc'), limit(10));
      const qs = await getDocs(qy);
      const list = document.getElementById('activityList');
      if (qs.empty){ list.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No recent activity</p>'; return; }
      let html = '';
      qs.forEach(d=>{
        const item = d.data();
        const date = item.processedAt?.toDate().toLocaleString() || 'Unknown';
        const files = item.files || [];
        const costText = item.freeScanUsed ? '(free)' : `-¬£${(item.cost || 0).toFixed(2)}`;
        let filesHtml='';
        if (files.length){
          filesHtml = '<div style="margin-top:8px;padding-top:8px;border-top:1px solid #e0e0e0;">';
          files.forEach(f=>{
            const icon = f.type?.includes('pdf') ? 'üìÑ' : 'üñºÔ∏è';
            filesHtml += `<div style="font-size:13px;margin-top:4px;"><a href="${f.url}" target="_blank" download="${f.name}" style="color:#1e3c72;text-decoration:none;">${icon} ${f.name}</a></div>`;
          });
          filesHtml += '</div>';
        }
        html += `
          <div class="activity-item">
            <div class="activity-info">
              <div><strong>${item.pages} page(s)</strong> ${files.length ? `- ${files.length} file(s)` : ''} ${item.letterType ? `<span style="margin-left:8px;font-size:12px;padding:2px 6px;border:1px solid #e0e0e0;border-radius:12px;">${item.letterType}</span>`:''}</div>
              <div class="activity-date">${date}</div>
              ${item.notes ? `<div style="color:#666;font-size:14px;margin-top:5px;">${item.notes}</div>` : ''}
              ${filesHtml}
            </div>
            <div class="activity-cost">${costText}</div>
            <button class="delete-btn" type="button" data-id="${d.id}">‚úï Delete</button>
          </div>`;
      });
      list.innerHTML = html;
    }

    // Delete a scan (files first, then doc)
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.delete-btn'); if (!btn) return;
      const mailItemId = btn.getAttribute('data-id'); if (!mailItemId) return;
      if (!confirm('Delete this scan? This will remove its files and record.')) return;

      try{
        const miRef = doc(db,'mailItems', mailItemId);
        const snap = await getDoc(miRef);
        if (snap.exists()){
          const data = snap.data();
          const files = Array.isArray(data.files) ? data.files : [];
          await Promise.all(files.map(async f=>{
            try{
              const fileRef = ref(storage, f.url); // accepts download URL
              await deleteObject(fileRef);
            }catch(err){
              console.warn('File delete failed (continuing):', f.url, err);
            }
          }));
        }
        await deleteDoc(miRef);
        showSuccess('Scan deleted');
        if (currentCustomer?.id) await loadRecentActivity(currentCustomer.id);
      }catch(err){
        console.error('delete scan error:', err);
        showError('Failed to delete scan: ' + err.message);
      }
    });
  </script>
</body>
</html>
