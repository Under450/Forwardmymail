<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Portal - Forward My Mail</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 1200px;
      margin: 0 auto;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header .logo {
      width: 120px;
      height: auto;
      margin-bottom: 15px;
      filter: brightness(0) invert(1);
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .content {
      padding: 40px;
    }

    .login-section, .portal-section {
      display: none;
    }

    .login-section.active, .portal-section.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1e3c72;
    }

    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .success-message.show {
      display: block;
    }

    .info-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .customer-selector {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .customer-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }

    .info-item {
      padding: 10px;
    }

    .info-label {
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-value {
      color: #333;
      font-size: 18px;
      font-weight: 600;
    }

    .credit-value {
      color: #1e3c72;
      font-size: 24px;
    }

    .low-credit {
      color: #dc3545;
    }

    .scan-form {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
    }

    .cost-display {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center.
    }

    .cost-amount {
      font-size: 32px;
      font-weight: bold;
      color: #1e3c72;
    }

    .logout-btn {
      background: #dc3545;
      margin-top: 20px;
    }

    .recent-activity {
      margin-top: 30px;
    }

    .activity-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .activity-info {
      flex: 1;
    }

    .activity-date {
      color: #666;
      font-size: 14px;
    }

    .activity-cost {
      font-weight: bold;
      color: #1e3c72;
    }

    .low-credit-warning {
      background: #fff3cd;
      border-left: 4px solid #ff9800;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      color: #856404;
    }

    .critical-credit-warning {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      color: #721c24;
    }

    .credit-value.low-credit {
      color: #ff9800 !important;
    }

    .credit-value.critical-credit {
      color: #dc3545 !important;
    }

    @media (max-width: 768px) {
      .customer-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.forwardmymail.co.uk/logo.png" alt="Forward My Mail" class="logo">
      <h1>Forward My Mail</h1>
      <p id="headerSubtitle">Staff Portal</p>
    </div>

    <div class="content">
      <!-- Login Section -->
      <div id="loginSection" class="login-section active">
        <h2 style="margin-bottom: 20px;">Staff Login</h2>
        <div id="errorMessage" class="error-message"></div>
        
        <form id="loginForm" autocomplete="off">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" required placeholder="staff@forwardmymail.co.uk" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required placeholder="Enter your password" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');">
          </div>
          
          <button type="submit" id="loginBtn">Login</button>
        </form>
        
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <p style="color: #666;">
            <a href="reset-password.html" style="color: #1e3c72; text-decoration: none; font-weight: 500;">Forgot password?</a>
          </p>
        </div>
      </div>

      <!-- Portal Section -->
      <div id="portalSection" class="portal-section">
        <div id="successMessage" class="success-message"></div>

        <!-- Customer Selector -->
        <div class="customer-selector">
          <h3 style="margin-bottom: 15px;">Select Customer</h3>
          <select id="customerSelect">
            <option value="">-- Select a customer --</option>
          </select>

          <div id="customerInfo" class="customer-info" style="display: none;">
            <div class="info-item">
              <div class="info-label">Customer Name</div>
              <div class="info-value" id="customerName">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Company</div>
              <div class="info-value" id="customerCompany">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value" id="customerEmail">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Credit Balance</div>
              <div class="info-value credit-value" id="customerCredits">¬£0.00</div>
            </div>
            <!-- NEW: free scans indicator -->
            <div class="info-item">
              <div class="info-label">Free scans left (this month)</div>
              <div class="info-value" id="customerFreeScans">0</div>
            </div>
          </div>
        </div>

        <!-- Low Credit Warning -->
        <div id="lowCreditWarning" style="display: none;"></div>

        <!-- NEW: grant free scan action -->
        <div id="freeScanActions" style="display:none; margin-bottom:20px;">
          <button id="addFreeScanBtn" type="button">Add 1 Free Scan</button>
        </div>

        <!-- Scan Processing Form -->
        <div class="scan-form" id="scanForm" style="display: none;">
          <h3 style="margin-bottom: 20px;">Process Mail Scan</h3>
          
          <div class="form-group">
            <label for="pages">Number of Pages</label>
            <input type="number" id="pages" min="1" value="1" required>
          </div>

          <div class="form-group">
            <label for="notes">Notes (Optional)</label>
            <textarea id="notes" rows="3" placeholder="Add any notes about this scan..."></textarea>
          </div>

          <div class="form-group">
            <label for="scanFiles">Upload Scanned Documents</label>
            <input type="file" id="scanFiles" multiple accept="image/*,.pdf" style="margin-bottom: 10px;">
            <div style="font-size: 13px; color: #666; margin-top: 5px;">
              Select one or more images (JPG, PNG) or PDF files
            </div>
            <div id="fileList" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
            <div id="uploadProgress" style="display: none; margin-top: 10px;">
              <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                <div id="progressBar" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
              </div>
              <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 13px; color: #666;"></div>
            </div>
          </div>

          <div class="cost-display">
            <div style="color: #666; margin-bottom: 5px;">Estimated Cost</div>
            <div class="cost-amount">¬£<span id="costAmount">0.50</span></div>
            <div style="color: #666; margin-top: 5px; font-size: 14px;">
              First page: ¬£0.50 | Additional: ¬£0.25/page
            </div>
          </div>

          <button id="processScanBtn" style="width: 100%; margin-top: 20px;">Process Scan</button>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity" id="recentActivity" style="display: none;">
          <h3 style="margin-bottom: 15px;">Recent Activity</h3>
          <div id="activityList">
            <p style="color: #666; text-align: center; padding: 20px;">No recent activity</p>
          </div>
        </div>

        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, query, where, orderBy, limit, updateDoc, addDoc, onSnapshot, serverTimestamp, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCToSDWiFy0zjDo4Amfe4_IV8z7N54jrQU",
      authDomain: "forward-my-mail.firebaseapp.com",
      projectId: "forward-my-mail",
      storageBucket: "forward-my-mail.firebasestorage.app",
      messagingSenderId: "933044287958",
      appId: "1:933044287958:web:fa3a707dbec62b24e74c77",
      measurementId: "G-J8M65WQCGH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements
    const loginSection = document.getElementById('loginSection');
    const portalSection = document.getElementById('portalSection');
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const customerSelect = document.getElementById('customerSelect');
    const customerInfo = document.getElementById('customerInfo');
    const scanForm = document.getElementById('scanForm');
    const recentActivity = document.getElementById('recentActivity');
    const pagesInput = document.getElementById('pages');
    const costAmount = document.getElementById('costAmount');
    const processScanBtn = document.getElementById('processScanBtn');
    const scanFilesInput = document.getElementById('scanFiles');
    const fileListDiv = document.getElementById('fileList');
    const uploadProgressDiv = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const addFreeScanBtn = document.getElementById('addFreeScanBtn');
    const customerFreeScansEl = document.getElementById('customerFreeScans');
    const freeScanActions = document.getElementById('freeScanActions');

    let currentCustomer = null;
    let unsubscribeCustomer = null;

    // Force clear login fields on page load (prevent autofill)
    window.addEventListener('load', () => {
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          await user.getIdToken(true);
          await loadCustomers();
          loginSection.classList.remove('active');
          portalSection.classList.add('active');
        } catch (error) {
          console.error('Error getting auth token:', error);
          showError('Authentication error. Please try logging in again.');
        }
      } else {
        loginSection.classList.add('active');
        portalSection.classList.remove('active');
        if (unsubscribeCustomer) unsubscribeCustomer();
      }
    });

    // Login form handler
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        showError('Invalid email or password');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    });

    // Logout handler
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        showError('Error logging out');
      }
    });

    // Load customers
    async function loadCustomers() {
      try {
        const querySnapshot = await getDocs(collection(db, 'customers'));
        customerSelect.innerHTML = '<option value="">-- Select a customer --</option>';
        querySnapshot.forEach((docSnap) => {
          const customer = docSnap.data();
          const option = document.createElement('option');
          option.value = docSnap.id;
          option.textContent = `${customer.name} - ${customer.company || 'No company'}`;
          customerSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading customers:', error);
        showError('Error loading customers');
      }
    }

    // Customer select handler
    customerSelect.addEventListener('change', async (e) => {
      const customerId = e.target.value;
      if (!customerId) {
        customerInfo.style.display = 'none';
        scanForm.style.display = 'none';
        recentActivity.style.display = 'none';
        freeScanActions.style.display = 'none';
        currentCustomer = null;
        if (unsubscribeCustomer) unsubscribeCustomer();
        return;
      }

      try {
        const customerDoc = await getDoc(doc(db, 'customers', customerId));
        if (customerDoc.exists()) {
          currentCustomer = { id: customerId, ...customerDoc.data() };
          displayCustomerInfo(currentCustomer);
          scanForm.style.display = 'block';
          recentActivity.style.display = 'block';
          await loadRecentActivity(customerId);

          // Real-time updates
          if (unsubscribeCustomer) unsubscribeCustomer();
          unsubscribeCustomer = onSnapshot(doc(db, 'customers', customerId), (snap) => {
            if (snap.exists()) {
              currentCustomer = { id: customerId, ...snap.data() };
              displayCustomerInfo(currentCustomer);
            }
          });
        }
      } catch (error) {
        console.error('Error loading customer:', error);
        showError('Error loading customer details');
      }
    });

    // Display customer info (with free scans + warnings)
    function displayCustomerInfo(customer) {
      document.getElementById('customerName').textContent = customer.name || '-';
      document.getElementById('customerCompany').textContent = customer.company || '-';
      document.getElementById('customerEmail').textContent = customer.email || '-';

      const credits = Number(customer.credits || 0);
      const freeScans = Number(customer.freeScansRemaining || 0);

      const creditsElement = document.getElementById('customerCredits');
      const warningElement = document.getElementById('lowCreditWarning');

      creditsElement.textContent = `¬£${credits.toFixed(2)}`;
      if (customerFreeScansEl) customerFreeScansEl.textContent = String(freeScans);

      // Reset classes
      creditsElement.classList.remove('low-credit', 'critical-credit');

      // Warnings (considering free scans)
      if (credits < 0.50 && freeScans <= 0) {
        creditsElement.classList.add('critical-credit');
        warningElement.className = 'critical-credit-warning';
        warningElement.innerHTML = '‚õî <strong>CRITICAL:</strong> Insufficient credits (¬£' + credits.toFixed(2) + ') and no free scans.';
        warningElement.style.display = 'block';
      } else if (credits < 0.50 && freeScans > 0) {
        creditsElement.classList.add('low-credit');
        warningElement.className = 'low-credit-warning';
        warningElement.innerHTML = '‚úÖ <strong>Free scans available:</strong> ' + freeScans + ' left this month. Scans will use these before credits.';
        warningElement.style.display = 'block';
      } else if (credits < 2.00) {
        const scansRemaining = Math.max(Math.floor((credits - 0.50) / 0.25) + 1, 0);
        creditsElement.classList.add('low-credit');
        warningElement.className = 'low-credit-warning';
        warningElement.innerHTML = '‚ö†Ô∏è <strong>LOW CREDITS:</strong> ¬£' + credits.toFixed(2) + ' (~' + scansRemaining + ' paid scan(s)). Free scans left: ' + freeScans + '.';
        warningElement.style.display = 'block';
      } else if (credits < 5.00) {
        creditsElement.classList.add('low-credit');
        warningElement.className = 'low-credit-warning';
        warningElement.innerHTML = 'üí° <strong>NOTICE:</strong> Credits getting low (¬£' + credits.toFixed(2) + '). Free scans left: ' + freeScans + '.';
        warningElement.style.display = 'block';
      } else {
        warningElement.style.display = 'none';
      }

      // Show free scan action once a customer is selected
      if (freeScanActions) freeScanActions.style.display = 'block';

      customerInfo.style.display = 'grid';
    }

    // Grant 1 free scan
    addFreeScanBtn?.addEventListener('click', async () => {
      if (!currentCustomer) return showError('Please select a customer first');
      try {
        addFreeScanBtn.disabled = true;
        await updateDoc(doc(db, 'customers', currentCustomer.id), {
          freeScansRemaining: increment(1)
        });
        showSuccess('Added 1 free scan');
      } catch (e) {
        showError('Failed to add free scan: ' + e.message);
      } finally {
        addFreeScanBtn.disabled = false;
      }
    });

    // Calculate cost display
    pagesInput.addEventListener('input', () => {
      const pages = parseInt(pagesInput.value) || 1;
      const cost = 0.50 + ((pages - 1) * 0.25);
      costAmount.textContent = cost.toFixed(2);
    });

    // File list display
    scanFilesInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) {
        fileListDiv.innerHTML = '';
        return;
      }
      const fileNames = files.map((f, i) => `${i + 1}. ${f.name} (${(f.size / 1024 / 1024).toFixed(2)} MB)`).join('<br>');
      fileListDiv.innerHTML = `<strong>${files.length} file(s) selected:</strong><br>${fileNames}`;
    });

    // Upload files to Storage
    async function uploadScanFiles(customerId, files) {
      const uploadedFiles = [];
      const timestamp = Date.now();
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileName = `${timestamp}_${i + 1}_${file.name}`;
        const storageRef = ref(storage, `mail-scans/${customerId}/${fileName}`);
        progressText.textContent = `Uploading ${i + 1} of ${files.length}: ${file.name}`;
        const uploadTask = uploadBytesResumable(storageRef, file);
        await new Promise((resolve, reject) => {
          uploadTask.on('state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              const overallProgress = ((i / files.length) + (progress / 100 / files.length)) * 100;
              progressBar.style.width = overallProgress + '%';
            },
            (error) => reject(error),
            async () => {
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              uploadedFiles.push({
                name: file.name,
                url: downloadURL,
                size: file.size,
                type: file.type
              });
              resolve();
            }
          );
        });
      }
      return uploadedFiles;
    }

    // Process scan (use free scans first, else charge credits)
    processScanBtn.addEventListener('click', async () => {
      if (!currentCustomer) {
        showError('Please select a customer first');
        return;
      }

      const pages = parseInt(pagesInput.value) || 1;
      const notes = document.getElementById('notes').value;
      const baseCost = 0.50 + ((pages - 1) * 0.25);
      const files = Array.from(scanFilesInput.files);

      const freeScans = Number(currentCustomer.freeScansRemaining || 0);
      let usedFreeScan = false;
      let effectiveCost = baseCost;

      if (freeScans > 0) {
        usedFreeScan = true;
        effectiveCost = 0;
      } else if ((currentCustomer.credits || 0) < baseCost) {
        showError(`Insufficient credits. Need ¬£${baseCost.toFixed(2)}, but customer only has ¬£${(currentCustomer.credits || 0).toFixed(2)}`);
        return;
      }

      try {
        processScanBtn.disabled = true;
        processScanBtn.textContent = 'Processing...';

        // Upload files if any
        let uploadedFiles = [];
        if (files.length > 0) {
          uploadProgressDiv.style.display = 'block';
          uploadedFiles = await uploadScanFiles(currentCustomer.id, files);
          uploadProgressDiv.style.display = 'none';
        }

        // Create mail item record
        await addDoc(collection(db, 'mailItems'), {
          customerId: currentCustomer.id,
          pages,
          cost: effectiveCost,
          notes,
          files: uploadedFiles,
          processedAt: serverTimestamp(),
          processedBy: auth.currentUser.email,
          status: 'scanned',
          freeScanUsed: usedFreeScan
        });

        // Update balances
        if (usedFreeScan) {
          await updateDoc(doc(db, 'customers', currentCustomer.id), {
            freeScansRemaining: increment(-1)
          });
          currentCustomer.freeScansRemaining = Math.max(freeScans - 1, 0);
        } else {
          const newCredits = (currentCustomer.credits || 0) - baseCost;
          await updateDoc(doc(db, 'customers', currentCustomer.id), { credits: newCredits });
          currentCustomer.credits = newCredits;
        }

        // Refresh UI
        displayCustomerInfo(currentCustomer);

        showSuccess(
          `Scan processed: ${pages} page(s) ‚Äî ${usedFreeScan ? 'free scan used' : '¬£' + baseCost.toFixed(2) + ' deducted'}.`
        );

        // Reset form
        pagesInput.value = 1;
        document.getElementById('notes').value = '';
        scanFilesInput.value = '';
        fileListDiv.innerHTML = '';
        costAmount.textContent = '0.50';
        progressBar.style.width = '0%';

        await loadRecentActivity(currentCustomer.id);
      } catch (error) {
        console.error('Error processing scan:', error);
        showError('Error processing scan: ' + error.message);
        uploadProgressDiv.style.display = 'none';
      } finally {
        processScanBtn.disabled = false;
        processScanBtn.textContent = 'Process Scan';
      }
    });

    // Load recent activity
    async function loadRecentActivity(customerId) {
      try {
        const q = query(
          collection(db, 'mailItems'),
          where('customerId', '==', customerId),
          orderBy('processedAt', 'desc'),
          limit(10)
        );
        const querySnapshot = await getDocs(q);
        const activityList = document.getElementById('activityList');
        
        if (querySnapshot.empty) {
          activityList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No recent activity</p>';
          return;
        }

        let html = '';
        querySnapshot.forEach((d) => {
          const item = d.data();
          const date = item.processedAt?.toDate().toLocaleString() || 'Unknown';
          const files = item.files || [];
          const costText = item.freeScanUsed ? '(free)' : `-¬£${(item.cost || 0).toFixed(2)}`;

          // Files list
          let filesHtml = '';
          if (files.length > 0) {
            filesHtml = '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">';
            files.forEach((file) => {
              const fileIcon = file.type?.includes('pdf') ? 'üìÑ' : 'üñºÔ∏è';
              filesHtml += `
                <div style="font-size: 13px; margin-top: 4px;">
                  <a href="${file.url}" target="_blank" download="${file.name}" style="color: #1e3c72; text-decoration: none;">
                    ${fileIcon} ${file.name}
                  </a>
                </div>
              `;
            });
            filesHtml += '</div>';
          }
          
          html += `
            <div class="activity-item">
              <div class="activity-info">
                <div><strong>${item.pages} page(s)</strong> ${files.length > 0 ? `- ${files.length} file(s)` : ''}</div>
                <div class="activity-date">${date}</div>
                ${item.notes ? `<div style="color: #666; font-size: 14px; margin-top: 5px;">${item.notes}</div>` : ''}
                ${filesHtml}
              </div>
              <div class="activity-cost">${costText}</div>
            </div>
          `;
        });

        activityList.innerHTML = html;
      } catch (error) {
        console.error('Error loading activity:', error);
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => errorMessage.classList.remove('show'), 5000);
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('show');
      setTimeout(() => successMessage.classList.remove('show'), 5000);
    }
  </script>
</body>
</html>
