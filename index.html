
=============================
FORWARDMYMAIL â€“ FULL & FINAL
=============================

This single TXT includes everything you asked for:
- A simple plan (in plain English)
- Supabase SQL (Auth + roles + tables + RLS)
- Backend (Node/Express) endpoints wired for Supabase Auth + OpenMeter
- Example .env
- Final HTML (My Credits + Staff, login modal, CSS tweaks)

You can copy/paste each section into files with the given filenames.


====================
1) SIMPLE STEP-BY-STEP
====================

A) SUPABASE (login)
-------------------
1. Create a Supabase project.
2. In Auth settings: enable
   - Email magic-link (customers)
   - Password + 2FA (staff)
3. In SQL Editor, paste "profiles & scans (SQL)" (see section 3).
4. Create users:
   - Staff: invite or insert into auth; set role='staff' in profiles.
   - Customers: when ready, set role='customer' and assign account_id (UUID).
5. Get your Project URL and Public Anon Key.

B) OPENMETER + STRIPE (billing & credits)
-----------------------------------------
1. In OpenMeter: connect Stripe app (invoices paid via Stripe).
2. Create:
   - Entitlement: scan_credits (metered balance)
   - Meter: scan (1 per scan)
   - Plan: Business Address (recurring)
   - Add-ons: Scan Pack 20/50... (multi-instance) that grant credits to scan_credits
3. For each customer, use a stable accountId (UUID) as OpenMeter "subject".

C) BACKEND (Node/Express)
-------------------------
1. Create a folder (e.g., server/). Put "package.json" and "server.js" from section 4.
2. Create a .env file with values from section 2.
3. Install & run:
   npm i
   npm run dev   (or npm start)
4. Verify endpoints:
   - GET /api/health  â†’ { ok: true }
   - (auth-protected tested via the HTML UI)

D) FRONTEND (HTML page)
-----------------------
1. Open the "final HTML" (section 5).
2. Paste your Supabase keys in the JS config.
3. Upload the HTML to your site (or open locally to test the UI).
4. When backend is running, set DEMO_MODE=false in HTML to use real APIs.

E) FLOW
-------
- Customers buy plans & packs in OpenMeter â†’ Stripe collects â†’ OpenMeter auto-grants.
- Staff panel checks remaining via backend â†’ if >0 â†’ upload PDF to Zendo â†’ backend records scan â†’ OpenMeter usage ingested (balance -1).
- Customers see balance and recent scans in "My Credits".


=================
2) .ENV (EXAMPLE)
=================
# --- Server config ---
PORT=3000
BASE_URL=http://localhost:3000

# --- Supabase ---
SUPABASE_URL=https://YOUR-PROJECT.supabase.co
SUPABASE_SERVICE_ROLE=YOUR_SERVICE_ROLE_KEY   # NEVER expose to browser

# --- OpenMeter ---
OM_BASE_URL=https://api.openmeter.cloud       # or your instance URL
OM_API_KEY=YOUR_OPENMETER_API_KEY

# --- Security ---
JWT_AUDIENCE=authenticated
JWT_ISSUER=https://YOUR-PROJECT.supabase.co


=================================
3) PROFILES & SCANS (SUPABASE SQL)
=================================
-- Run these in Supabase SQL editor

-- 3.1 Profiles (roles/identity)
create table if not exists public.profiles (
  user_id uuid primary key references auth.users(id) on delete cascade,
  email text unique,
  role text not null check (role in ('customer','staff','admin')),
  account_id uuid, -- OpenMeter subject (null for staff)
  created_at timestamptz default now()
);
alter table public.profiles enable row level security;

-- Customers can read only their row
create policy if not exists profiles_select_self
on public.profiles for select
to authenticated
using (auth.uid() = user_id);

-- Staff/admin can read all profiles (optional for internal tools)
create policy if not exists profiles_select_staff
on public.profiles for select
to authenticated
using (
  exists(select 1 from public.profiles p where p.user_id = auth.uid() and p.role in ('staff','admin'))
);

-- 3.2 Scans (audit log)
create table if not exists public.scans (
  id bigserial primary key,
  account_id uuid not null,
  staff_user_id uuid not null references auth.users(id) on delete restrict,
  mail_item_id text,
  object_key text,            -- where the PDF lives (e.g., Zendo ref or S3 key)
  created_at timestamptz default now()
);
alter table public.scans enable row level security;

-- Customers: can see only their scans
create policy if not exists scans_select_customer
on public.scans for select
to authenticated
using (
  exists(
    select 1 from public.profiles p
    where p.user_id = auth.uid() and p.account_id = scans.account_id and p.role = 'customer'
  )
);

-- Staff/admin: can select all
create policy if not exists scans_select_staff
on public.scans for select
to authenticated
using (
  exists(select 1 from public.profiles p where p.user_id = auth.uid() and p.role in ('staff','admin'))
);

-- Staff/admin: can insert scans
create policy if not exists scans_insert_staff
on public.scans for insert
to authenticated
with check (
  exists(select 1 from public.profiles p where p.user_id = auth.uid() and p.role in ('staff','admin'))
);


==========================================
4) BACKEND (NODE/EXPRESS) â€“ TWO FILES
==========================================

---------- server/package.json ----------
{
  "name": "fmm-server",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "node server.js",
    "dev": "node --watch server.js"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.45.0",
    "body-parser": "^1.20.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "helmet": "^7.1.0",
    "node-fetch": "^3.3.2"
  }
}

---------- server/server.js ----------
import 'dotenv/config';
import express from 'express';
import helmet from 'helmet';
import cors from 'cors';
import bodyParser from 'body-parser';
import fetch from 'node-fetch';
import { createClient } from '@supabase/supabase-js';

const app = express();
app.use(helmet());
app.use(cors({ origin: true, credentials: true }));
app.use(bodyParser.json({ limit: '10mb' }));

const PORT = process.env.PORT || 3000;
const BASE_URL = process.env.BASE_URL || `http://localhost:${PORT}`;

// Supabase (service role for server-side verification)
const supa = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE);

// OpenMeter
const OM_BASE = process.env.OM_BASE_URL;
const OM_KEY  = process.env.OM_API_KEY;

// --- Helpers ---
async function verifySupabaseToken(req, res, next) {
  try {
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) return res.status(401).json({ error: 'Missing token' });

    const { data, error } = await supa.auth.getUser(token);
    if (error || !data?.user) return res.status(401).json({ error: 'Invalid token' });

    // Fetch profile for role/account_id
    const { data: profile, error: pErr } = await supa
      .from('profiles')
      .select('role, account_id, email')
      .eq('user_id', data.user.id)
      .single();

    if (pErr || !profile) return res.status(403).json({ error: 'Profile not found' });
    req.user = { id: data.user.id, email: profile.email, role: profile.role, accountId: profile.account_id };
    next();
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'Auth verify failed' });
  }
}

function requireRole(...roles) {
  return (req, res, next) => roles.includes(req.user?.role) ? next() : res.status(403).json({ error: 'Forbidden' });
}

async function openmeterGetEntitlementValue(accountId, entitlementKey) {
  const url = `${OM_BASE}/entitlements/${encodeURIComponent(entitlementKey)}/value?subject=${encodeURIComponent(accountId)}`;
  const r = await fetch(url, { headers: { Authorization: `Bearer ${OM_KEY}` } });
  if (!r.ok) throw new Error(`OpenMeter value ${r.status}`);
  return await r.json(); // { remaining, ... }
}

async function openmeterIngestScan(accountId) {
  const url = `${OM_BASE}/events`;
  const evt = {
    type: 'scan',
    subject: accountId,
    timestamp: new Date().toISOString(),
    value: 1
  };
  const r = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type':'application/cloudevents+json', Authorization: `Bearer ${OM_KEY}` },
    body: JSON.stringify(evt)
  });
  if (!r.ok) throw new Error(`OpenMeter ingest ${r.status}`);
  return true;
}

// --- Health ---
app.get('/api/health', (_req, res) => res.json({ ok: true }));

// --- Customer endpoints ---
app.get('/api/me/balance', verifySupabaseToken, async (req, res) => {
  try {
    if (req.user.role !== 'customer') return res.status(403).json({ error: 'Customers only' });
    const val = await openmeterGetEntitlementValue(req.user.accountId, 'scan_credits');
    res.json({ remaining: val?.remaining ?? 0 });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'Failed to fetch balance' });
  }
});

app.get('/api/me/history', verifySupabaseToken, async (req, res) => {
  try {
    if (req.user.role !== 'customer') return res.status(403).json({ error: 'Customers only' });
    const { data, error } = await supa
      .from('scans')
      .select('id, created_at, mail_item_id, object_key')
      .eq('account_id', req.user.accountId)
      .order('created_at', { ascending: false })
      .limit(50);
    if (error) throw error;
    const rows = (data || []).map(r => ({
      id: r.id, date: r.created_at, itemRef: r.mail_item_id, objectKey: r.object_key, status: 'Ready'
    }));
    res.json(rows);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'Failed to fetch history' });
  }
});

// --- Staff endpoints ---
app.get('/api/admin/search', verifySupabaseToken, requireRole('staff','admin'), async (req, res) => {
  try {
    const q = String(req.query.query || '').toLowerCase();
    // Simple search across profiles where account_id IS NOT NULL
    let qb = supa.from('profiles').select('email, role, account_id').not('account_id','is', null);
    const { data, error } = await qb;
    if (error) throw error;
    const out = (data || []).filter(r =>
        (r.email||'').toLowerCase().includes(q) || (r.account_id||'').toLowerCase().includes(q)
      ).map(r => ({
        email: r.email, accountId: r.account_id, name: r.email.split('@')[0], mailbox: r.account_id?.slice(0,8).toUpperCase()
      }));
    res.json(out);
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'Search failed' });
  }
});

app.get('/api/admin/balance', verifySupabaseToken, requireRole('staff','admin'), async (req, res) => {
  try {
    const accountId = String(req.query.accountId || '');
    if (!accountId) return res.status(400).json({ error: 'Missing accountId' });
    const val = await openmeterGetEntitlementValue(accountId, 'scan_credits');
    res.json({ remaining: val?.remaining ?? 0 });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'Failed to fetch balance' });
  }
});

app.post('/api/admin/scan', verifySupabaseToken, requireRole('staff','admin'), async (req, res) => {
  try {
    const { accountId, mailItemId, objectKey } = req.body || {};
    if (!accountId) return res.status(400).json({ error: 'Missing accountId' });
    const val = await openmeterGetEntitlementValue(accountId, 'scan_credits');
    if (!val || (val.remaining ?? 0) < 1) return res.json({ allowed: false, reason: 'no_credits' });

    // Record scan row
    const { error } = await supa.from('scans').insert({
      account_id: accountId,
      staff_user_id: req.user.id,
      mail_item_id: mailItemId || null,
      object_key: objectKey || null
    });
    if (error) throw error;

    // Consume 1 credit
    await openmeterIngestScan(accountId);
    res.json({ allowed: true });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: 'Scan failed' });
  }
});

app.listen(PORT, () => console.log(`FMM server listening on ${PORT}`));


====================================
4.1) OPENMETER SUBJECT CREATION TIP
====================================
When you create a new customer in your DB, also create an OpenMeter "customer" or set the subject mapping:

- Use your internal UUID as the OpenMeter "subject" (accountId).
- If you maintain OpenMeter customers, map usageAttribution.subjects = [accountId].
- For prepaid packs (Option 1), OpenMeter grants credits automatically on successful invoice payment.


========================
5) FINAL HTML (FRONTEND)
========================
- Paste your Supabase URL + Anon key in the config block.
- Set DEMO_MODE=false when backend is ready; until then, it works with local demo data.
- This HTML assumes youâ€™ve added two links in your header nav pointing to #credits and #admin.
- It appends sections and the login modal without changing your template.

----- BEGIN HTML -----
<!-- Save as forwardmymail.html (or your main page). If you already have a page, paste the
     panels BEFORE </main> and the scripts BEFORE </body>. -->

<!-- CREDITS & STAFF SECTIONS (append before </main>) -->
<section id="credits">
  <div class="container">
    <div class="section-header">
      <div class="section-kicker">My Credits</div>
      <h2 class="section-title">Scan credit balance & recent scans</h2>
      <p class="section-subtitle">Log in below to view your remaining scans.</p>
    </div>
    <div class="contact-form" style="margin-bottom: 1rem;">
      <div class="form-row">
        <div class="form-group">
          <label for="custEmail">Email</label>
          <input id="custEmail" type="email" placeholder="you@example.com"/>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" id="custLoginBtn" type="button">View Balance</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Status</label>
          <input id="custStatus" type="text" value="Not logged in" readonly/>
        </div>
        <div class="form-group">
          <label>Remaining scans</label>
          <input id="custRemain" type="text" value="â€”" readonly/>
        </div>
      </div>
    </div>
    <div class="pricing-extra">
      <div class="pricing-extra-header">Recent scans</div>
      <div class="pricing-extra-body">
        <table class="pricing-table" id="custHistory">
          <thead><tr><th>Date</th><th>Mail item</th><th>Status</th></tr></thead>
          <tbody><tr><td colspan="3">No activity yet.</td></tr></tbody>
        </table>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn btn-outline" href="#pricing">Buy a plan</a>
          <a class="btn btn-outline" href="https://forwardmymail.getzendo.io/login" target="_blank" rel="noopener">Client Portal</a>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="admin">
  <div class="container">
    <div class="section-header">
      <div class="section-kicker">Staff</div>
      <h2 class="section-title">Check balance & record a scan</h2>
      <p class="section-subtitle">Search a customer, check entitlement, then record a scan (consumes 1 credit).</p>
    </div>
    <div class="contact-form">
      <div class="form-row">
        <div class="form-group">
          <label for="q">Search (email / name / mailbox)</label>
          <input id="q" type="text" placeholder="alice@example.com"/>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-outline" id="find" type="button">Find</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="acct">Customer</label>
          <select id="acct"><option value="">â€” Select a customer â€”</option></select>
        </div>
        <div class="form-group">
          <label>Remaining</label>
          <input id="rem" type="text" value="â€”" readonly/>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-outline" id="check" type="button">Check Balance</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="mailItemId">Mail item ID</label>
          <input id="mailItemId" type="text" placeholder="Auto-generated if empty"/>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" id="scan" type="button" disabled>Scan &amp; Send</button>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Result</label>
          <input id="scanStatus" type="text" value="" readonly/>
        </div>
      </div>
      <div style="margin-top:10px;">
        <div class="pricing-extra">
          <div class="pricing-extra-header">Scan log</div>
          <div class="pricing-extra-body">
            <table class="pricing-table" id="adminLog">
              <thead><tr><th>Date</th><th>Account</th><th>Mail item</th><th>Result</th></tr></thead>
              <tbody><tr><td colspan="4">No scans yet.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- NAV BUTTON SIZE + ALIGNMENT + GAP (append before </head>) -->
<style id="fmm-nav-overrides">
header .nav-actions .btn { padding: 0.42rem 0.8rem !important; font-size: 0.9rem !important; line-height: 1.05 !important; border-radius: 8px !important; }
header .nav-actions .btn.btn-primary { padding: 0.46rem 0.9rem !important; font-size: 0.92rem !important; }
header .nav-actions .btn.btn-outline { padding: 0.40rem 0.78rem !important; font-size: 0.88rem !important; }
header .navbar-inner { justify-content: flex-start !important; }
header .nav-actions { margin-left: auto !important; }
@media (min-width: 768px){ header .nav-actions { margin-right: -8px !important; } }
header .nav-actions .btn:first-child { margin-left: 20px !important; }
#credits, #admin { scroll-margin-top: 80px; }
</style>

<!-- AUTH MODAL + SUPABASE + UI/ENDPOINT WIRING (append before </body>) -->
<!-- Login modal -->
<div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;">
  <div style="max-width:420px; margin:10vh auto; background:#fff; border-radius:12px; padding:20px;">
    <h3>Sign in</h3>
    <p id="authMsg" style="color:#666">Customers: magic link. Staff: password. (Demo mode shows both.)</p>
    <div style="display:flex; gap:8px; margin:10px 0;">
      <input id="authEmail" type="email" placeholder="you@example.com" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
    </div>
    <div id="pwRow" style="display:none; gap:8px; margin:10px 0;">
      <input id="authPassword" type="password" placeholder="Password (staff only)" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="authClose" class="btn btn-outline" type="button">Cancel</button>
      <button id="magicBtn" class="btn btn-primary" type="button">Send magic link</button>
      <button id="pwBtn" class="btn btn-outline" type="button">Staff sign in</button>
    </div>
    <div id="demoBanner" style="display:none; margin-top:10px; font-size:12px; color:#555;">Demo mode active: no keys configured.</div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== Config =====
const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";   // TODO set real project URL
const SUPABASE_ANON = "YOUR_PUBLIC_ANON_KEY";              // TODO set anon key
const DEMO_MODE = SUPABASE_URL.includes("YOUR-PROJECT");
const API_BASE = ""; // same origin, or set to your server URL

// Demo data (used only if DEMO_MODE=true)
const demo = {
  accounts: [
    { accountId: 'acct-001', email: 'alice@example.com', name: 'Alice Cooper', mailbox: 'MBX-1001', remaining: 7, history: [
      { ts: '2025-10-02', type: 'grant', qty: 10, note: 'Top-up' },
      { ts: '2025-11-16', type: 'scan',  qty: -1, note: 'Letter scan' },
      { ts: '2025-12-03', type: 'scan',  qty: -1, note: 'Letter scan' },
    ]},
    { accountId: 'acct-002', email: 'bob@acme.co.uk', name: 'Bob at ACME Ltd', mailbox: 'MBX-2042', remaining: 0, history: [
      { ts: '2025-09-01', type: 'grant', qty: 20, note: 'Welcome pack' },
      { ts: '2025-11-01', type: 'scan',  qty: -1, note: 'Invoice scan' },
      { ts: '2025-12-10', type: 'scan',  qty: -19, note: 'Bulk scans (import)' },
    ]},
    { accountId: 'acct-003', email: 'charlie@startup.io', name: 'Charlie Startup', mailbox: 'MBX-3007', remaining: 3, history: [
      { ts: '2025-08-12', type: 'grant', qty: 5, note: 'Top-up' },
      { ts: '2025-12-01', type: 'scan',  qty: -2, note: 'Scans' },
    ]},
  ]
};
function fmt(d){ return new Date(d).toISOString().slice(0,10); }
function esc(s){ return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'}[m])); }
function demoFindByEmail(email){ return demo.accounts.find(a => a.email.toLowerCase() === String(email||'').toLowerCase()); }
function demoFindById(id){ return demo.accounts.find(a => a.accountId === id); }

// Supabase client
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } });

// Modal open/close
const authModal = document.getElementById('authModal');
function openAuth(){ authModal.style.display='block'; if (DEMO_MODE) document.getElementById('demoBanner').style.display='block'; }
function closeAuth(){ authModal.style.display='none'; }
document.getElementById('authClose').onclick = closeAuth;

// Gate nav links
document.getElementById('myCreditsLink')?.addEventListener('click', async (e) => {
  if (DEMO_MODE) return; // allow demo
  const { data: { user } } = await sb.auth.getUser();
  if (!user) { e.preventDefault(); openAuth(); }
});
document.getElementById('staffPanelLink')?.addEventListener('click', async (e) => {
  if (DEMO_MODE) return;
  const role = await getRole();
  if (role!=='staff' && role!=='admin') { e.preventDefault(); openAuth(); }
});

function setMsg(t){ document.getElementById('authMsg').textContent = t; }

// Magic-link for customers
document.getElementById('magicBtn').onclick = async () => {
  const email = document.getElementById('authEmail').value.trim();
  if (!email) return setMsg("Enter your email");
  if (DEMO_MODE) { window.FMM = { role:'customer', email, accountId: (demoFindByEmail(email)||{}).accountId || 'acct-001' }; setMsg("Demo: signed in"); closeAuth(); refreshUI(); return; }
  const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  if (error) return setMsg(error.message); setMsg("Check your email for a sign-in link.");
};

// Staff password sign-in
document.getElementById('pwBtn').onclick = async () => {
  const pwRow = document.getElementById('pwRow');
  const email = document.getElementById('authEmail').value.trim();
  if (pwRow.style.display==='none'){ pwRow.style.display='flex'; document.getElementById('authPassword').focus(); return; }
  const password = document.getElementById('authPassword').value;
  if (!email || !password) return setMsg("Email and password required");
  if (DEMO_MODE) { window.FMM = { role:'staff', email }; setMsg("Demo: staff signed in"); closeAuth(); refreshUI(); return; }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return setMsg(error.message); setMsg("Signed in."); closeAuth(); refreshUI();
};

async function getRole(){
  if (DEMO_MODE) return window.FMM?.role || null;
  const { data: { user } } = await sb.auth.getUser();
  if (!user) return null;
  // In production, you can fetch role via a small API using the bearer token.
  // For now, assume customer unless you build a role endpoint.
  return window.FMM?.role || 'customer';
}
async function getToken(){
  if (DEMO_MODE) return null;
  const { data: { session } } = await sb.auth.getSession();
  return session?.access_token || null;
}

async function refreshUI(){
  const role = await getRole();
  const adminForm = document.querySelector('#admin .contact-form');
  if (adminForm) adminForm.style.display = (role==='staff'||role==='admin') ? '' : (DEMO_MODE ? '' : 'none');
}
sb.auth.onAuthStateChange((_e,_s)=>refreshUI());
refreshUI();

// ---- Credits panel (demo or real) ----
(function(){
  const email = document.getElementById('custEmail');
  const btn = document.getElementById('custLoginBtn');
  const status = document.getElementById('custStatus');
  const remain = document.getElementById('custRemain');
  const histBody = document.querySelector('#custHistory tbody');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    if (DEMO_MODE) {
      const acct = demoFindByEmail(email.value);
      if(!acct){ status.value='No account for that email'; remain.value='â€”'; histBody.innerHTML='<tr><td colspan="3">No activity.</td></tr>'; return; }
      status.value = `Logged in as ${acct.name}`;
      remain.value = String(acct.remaining);
      histBody.innerHTML = '';
      for(const h of acct.history.slice().reverse()){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${h.ts}</td><td>${esc(h.note||'â€”')}</td><td>${h.type}</td>`;
        histBody.appendChild(tr);
      }
      return;
    }
    // Real call (requires backend)
    const token = await getToken();
    const r1 = await fetch(`${API_BASE}/api/me/balance`, { headers: { Authorization: `Bearer ${token}` }, credentials:'include' });
    const j1 = await r1.json(); remain.value = j1.remaining ?? '0';
    const r2 = await fetch(`${API_BASE}/api/me/history`, { headers: { Authorization: `Bearer ${token}` }, credentials:'include' });
    const rows = await r2.json();
    status.value = 'Logged in';
    histBody.innerHTML = '';
    if (!rows.length){ histBody.innerHTML = '<tr><td colspan="3">No scans yet.</td></tr>'; return; }
    for(const s of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${esc(s.date)}</td><td>${esc(s.itemRef||'â€”')}</td><td>${esc(s.status||'Ready')}</td>`;
      histBody.appendChild(tr);
    }
  });
})();

// ---- Staff panel (demo or real) ----
(function(){
  const findBtn = document.getElementById('find');
  const q = document.getElementById('q');
  const sel = document.getElementById('acct');
  const checkBtn = document.getElementById('check');
  const rem = document.getElementById('rem');
  const scanBtn = document.getElementById('scan');
  const mailId = document.getElementById('mailItemId');
  const logBody = document.querySelector('#adminLog tbody');
  const status = document.getElementById('scanStatus');
  if (!findBtn) return;

  function populate(list){
    sel.innerHTML = '<option value="">â€” Select a customer â€”</option>';
    list.forEach(a => {
      const o = document.createElement('option');
      o.value = a.accountId;
      o.textContent = `${a.mailbox} â€” ${a.name} (${a.email})`;
      sel.appendChild(o);
    });
  }

  findBtn.addEventListener('click', async () => {
    if (DEMO_MODE) {
      const t = (q.value||'').toLowerCase().trim();
      const list = demo.accounts.filter(a =>
        a.email.toLowerCase().includes(t) || a.name.toLowerCase().includes(t) || a.mailbox.toLowerCase().includes(t) || a.accountId.toLowerCase().includes(t)
      ).map(a => ({ email:a.email, accountId:a.accountId, name:a.name, mailbox:a.mailbox }));
      populate(list); rem.value='â€”'; scanBtn.disabled=true; status.value=''; return;
    }
    const token = await getToken();
    const r = await fetch(`${API_BASE}/api/admin/search?query=${encodeURIComponent(q.value)}`, { headers: { Authorization: `Bearer ${token}` }, credentials:'include' });
    const list = await r.json();
    populate(list); rem.value='â€”'; scanBtn.disabled=true; status.value='';
  });

  checkBtn.addEventListener('click', async () => {
    if (!sel.value) return;
    if (DEMO_MODE) {
      const acct = demoFindById(sel.value);
      rem.value = acct ? String(acct.remaining) : 'â€”';
      scanBtn.disabled = !acct || acct.remaining <= 0;
      return;
    }
    const token = await getToken();
    const r = await fetch(`${API_BASE}/api/admin/balance?accountId=${encodeURIComponent(sel.value)}`, { headers: { Authorization: `Bearer ${token}` }, credentials:'include' });
    const j = await r.json();
    rem.value = j.remaining ?? '0';
    scanBtn.disabled = (j.remaining ?? 0) <= 0;
  });

  scanBtn.addEventListener('click', async () => {
    if (!sel.value) return;
    const id = mailId.value || ('MI-' + Math.random().toString(36).slice(2,8).toUpperCase());
    if (DEMO_MODE) {
      const acct = demoFindById(sel.value);
      if(!acct){ status.value='Select a customer'; return; }
      if(acct.remaining <= 0){ status.value='No credits. Top up required.'; return; }
      acct.remaining -= 1; acct.history.push({ ts: fmt(Date.now()), type:'scan', qty:-1, note:`Mail ${id}` });
      rem.value = String(acct.remaining);
      scanBtn.disabled = acct.remaining <= 0;
      status.value = 'Scan recorded (demo)';
      const firstCell = logBody.querySelector('td'); if (firstCell && firstCell.getAttribute('colspan')==='4') logBody.innerHTML='';
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${fmt(Date.now())}</td><td>${esc(acct.mailbox)} (${esc(acct.accountId)})</td><td>${esc(id)}</td><td>Recorded</td>`;
      logBody.appendChild(tr);
      return;
    }
    const token = await getToken();
    const r = await fetch(`${API_BASE}/api/admin/scan`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', Authorization: `Bearer ${token}` },
      credentials:'include',
      body: JSON.stringify({ accountId: sel.value, mailItemId: id })
    });
    const j = await r.json();
    if (!j.allowed){ status.value = 'No credits. Top up required.'; return; }
    status.value = 'Scan recorded';
    const firstCell = logBody.querySelector('td'); if (firstCell && firstCell.getAttribute('colspan')==='4') logBody.innerHTML='';
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${fmt(Date.now())}</td><td>${esc(sel.value)}</td><td>${esc(id)}</td><td>Recorded</td>`;
    logBody.appendChild(tr);
  });
})();
</script>
----- END HTML -----


=================
YOU ARE DONE ðŸŽ‰
=================

â€¢ Upload the HTML. Test in DEMO_MODE first.
â€¢ Set Supabase keys in HTML to switch to real auth.
â€¢ Deploy the backend, set .env, and test the /api routes from the HTML.
â€¢ Finish OpenMeter Billing setup (plan + add-ons); credits will grant automatically after payment.
â€¢ Staff can now scan confidently; customers can self-serve balance and recent scans.
