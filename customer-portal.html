<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Portal - Forward My Mail</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .container { background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.3); max-width:900px; width:100%; overflow:hidden; position:relative; }
    .header { background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); color:#fff; padding:30px; text-align:center; }
    .header .logo { width:120px; height:auto; margin-bottom:15px; filter:brightness(0) invert(1); }
    .header h1 { font-size:28px; margin-bottom:10px; }
    .content { padding:40px; position:relative; }

    .login-section, .portal-section { display:none; }
    .login-section.active, .portal-section.active { display:block; }

    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; color:#333; font-weight:500; }
    input { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:16px; transition:border-color .3s; }
    input:focus { outline:none; border-color:#1e3c72; }
    button {
      width:100%; padding:12px; background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#fff; border:none; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer; transition:transform .2s;
    }
    button:hover { transform:translateY(-2px); }
    button:active { transform:translateY(0); }

    .error-message { background:#fee; color:#c33; padding:12px; border-radius:8px; margin-bottom:20px; display:none; }
    .error-message.show { display:block; }
    .success-message { background:#efe; color:#3c3; padding:12px; border-radius:8px; margin-bottom:20px; display:none; }
    .success-message.show { display:block; }

    .info-card { background:#f8f9fa; border-radius:12px; padding:20px; margin-bottom:20px; }
    .info-row { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid #e0e0e0; }
    .info-row:last-child { border-bottom:none; }
    .info-label { color:#666; font-weight:500; }
    .info-value { color:#333; font-weight:600; }
    .credit-balance { font-size:32px; color:#1e3c72; }

    .credit-packs { display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:15px; margin-top:20px; }
    @media (min-width:768px){ .credit-packs{ grid-template-columns:repeat(5,1fr);} }
    .credit-pack { background:#fff; border:2px solid #e0e0e0; border-radius:12px; padding:20px; text-align:center; cursor:pointer; transition:.2s; }
    .credit-pack:hover { border-color:#1e3c72; transform:translateY(-4px); box-shadow:0 4px 12px rgba(102,126,234,.2); }
    .pack-amount { font-size:24px; font-weight:800; color:#1e3c72; margin-bottom:8px; }
    .logout-btn { background:#dc3545; margin-top:20px; }

    .mail-items { margin-top:30px; }
    .mail-item { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:15px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; }
    .mail-item-info { flex:1; }
    .mail-item-date { color:#666; font-size:14px; }
    .mail-item-status { padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; }
    .status-scanned { background:#d4edda; color:#155724; }
    .status-pending { background:#fff3cd; color:#856404; }

    .low-balance-warning { background:#fff3cd; border-left:4px solid #ffc107; padding:15px; border-radius:8px; margin-bottom:20px; display:none; }
    .low-balance-warning.show { display:block; }
    .critical-credit-warning { background:#f8d7da; border-left:4px solid #dc3545; padding:15px; border-radius:8px; margin-bottom:20px; font-weight:500; color:#721c24; display:none; }
    .critical-credit-warning.show { display:block; }

    /* Gating overlay (shown only when ID required & not approved) */
    #gateOverlay {
      position:absolute; inset:0; background:rgba(255,255,255,.85);
      backdrop-filter:saturate(0.7) blur(1px);
      display:none; align-items:center; justify-content:center; z-index:10;
      text-align:center; padding:20px;
    }
    #gateBadge {
      position:fixed; bottom:22px; left:50%; transform:translateX(-50%);
      background:#b23b3b; color:#fff; font-weight:800; letter-spacing:.04em;
      padding:12px 18px; border-radius:16px; box-shadow:0 8px 24px rgba(178,59,59,.35);
      display:none; z-index:11;
    }
    .allow-while-gated { position:relative; z-index:11; } /* sections the user can still click while gated */

    @media (max-width:768px){ .credit-packs{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.forwardmymail.co.uk/logo.png" alt="Forward My Mail" class="logo"/>
      <h1>Forward My Mail</h1>
      <p id="portalTitle">Customer Portal</p>
    </div>

    <div class="content">
      <!-- Overlay & badge for gated accounts -->
      <div id="gateOverlay">
        <div>
          <p style="font-weight:600;color:#333;margin-bottom:8px;">Please complete your identity verification.</p>
          <p style="color:#666;">Scanning and portal actions are disabled until approved. You can still purchase credits or plans below.</p>
        </div>
      </div>
      <div id="gateBadge">ID CHECK REQUIRED</div>

      <!-- Login -->
      <div id="loginSection" class="login-section active">
        <h2 style="margin-bottom:20px;">Customer Login</h2>
        <div id="errorMessage" class="error-message"></div>

        <form id="loginForm" autocomplete="off">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" required placeholder="your@email.com" autocomplete="off" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required placeholder="Enter your password" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');"/>
          </div>

          <button type="submit" id="loginBtn">Login</button>
          <button type="button" onclick="window.location.href='signup.html'"
            style="background:#fff; color:#1e3c72; border:2px solid #1e3c72; margin-top:10px;">Create Account</button>
        </form>

        <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #e0e0e0;">
          <p style="color:#666;margin-bottom:10px;">
            <a href="reset-password.html" style="color:#1e3c72;text-decoration:none;font-weight:500;">Forgot password?</a>
          </p>
        </div>
      </div>

      <!-- Portal -->
      <div id="portalSection" class="portal-section">
        <div id="successMessage" class="success-message"></div>

        <div id="lowBalanceWarning" class="low-balance-warning">
          ‚ö†Ô∏è Low credit balance! Please purchase more credits to continue receiving mail scans.
        </div>

        <div class="info-card">
          <div class="info-row"><span class="info-label">Welcome</span><span class="info-value" id="userName">Loading...</span></div>
          <div class="info-row"><span class="info-label">Credit Balance</span><span class="info-value credit-balance">¬£<span id="creditBalance">0.00</span></span></div>
        </div>

        <!-- Purchases (allowed while gated) -->
        <div class="allow-while-gated">
          <h3 style="margin-bottom:15px;">Purchase Credits</h3>
          <p style="color:#666;margin-bottom:20px;">Add credits to your account for mail scanning services</p>
          <div class="credit-packs">
            <div class="credit-pack" data-amount="10"><div class="pack-amount">¬£10</div></div>
            <div class="credit-pack" data-amount="20"><div class="pack-amount">¬£20</div></div>
            <div class="credit-pack" data-amount="25"><div class="pack-amount">¬£25</div></div>
            <div class="credit-pack" data-amount="30"><div class="pack-amount">¬£30</div></div>
            <div class="credit-pack" data-amount="50"><div class="pack-amount">¬£50</div></div>
          </div>

          <h3 style="margin-top:30px;margin-bottom:15px;">Mailbox Plans</h3>
          <p style="color:#666;margin-bottom:20px;">Annual virtual mailbox subscriptions</p>

          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;">
            <a href="https://buy.stripe.com/dRm4gB0nWcbv2Up4Ka4Ja0d" target="_blank" rel="noopener"
               style="display:block;text-decoration:none;background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:18px;text-align:center;transition:.2s;">
              <div style="font-size:26px;font-weight:800;color:#1e3c72;margin-bottom:6px;">¬£125<span style="font-weight:600;font-size:16px;">/year</span></div>
              <div style="color:#666;font-size:14px;line-height:1.2;">Personal<br/>Mailbox</div>
            </a>
            <a href="https://buy.stripe.com/cNi28t1s0b7rcuZekK4Ja0e" target="_blank" rel="noopener"
               style="display:block;text-decoration:none;background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:18px;text-align:center;transition:.2s;">
              <div style="font-size:26px;font-weight:800;color:#1e3c72;margin-bottom:6px;">¬£175<span style="font-weight:600;font-size:16px;">/year</span></div>
              <div style="color:#666;font-size:14px;line-height:1.2;">Business<br/>Mailbox</div>
            </a>
            <a href="https://buy.stripe.com/28E8wRb2A1wR2Up90q4Ja0f" target="_blank" rel="noopener"
               style="display:block;text-decoration:none;background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:18px;text-align:center;transition:.2s;">
              <div style="font-size:26px;font-weight:800;color:#1e3c72;margin-bottom:6px;">¬£225<span style="font-weight:600;font-size:16px;">/year</span></div>
              <div style="color:#666;font-size:14px;line-height:1.2;">Premium<br/>Mailbox</div>
            </a>
            <a href="https://buy.stripe.com/eVq9AV1s0grL66B6Si4Ja02" target="_blank" rel="noopener"
               style="display:block;text-decoration:none;background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:18px;text-align:center;transition:.2s;">
              <div style="font-size:26px;font-weight:800;color:#1e3c72;margin-bottom:6px;">¬£299<span style="font-weight:600;font-size:16px;">/year</span></div>
              <div style="color:#666;font-size:14px;line-height:1.2;">Full Virtual<br/>Office</div>
            </a>
          </div>
        </div>

        <div class="mail-items" id="mailItemsBlock">
          <h3 style="margin-bottom:15px;">Recent Mail Items</h3>
          <div id="mailItemsList">
            <p style="color:#666;text-align:center;padding:20px;">No recent mail items</p>
          </div>
        </div>

        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, browserSessionPersistence, setPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, query, collection, where, orderBy, limit, getDocs, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCToSDWiFy0zjDo4Amfe4_IV8z7N54jrQU",
      authDomain: "forward-my-mail.firebaseapp.com",
      projectId: "forward-my-mail",
      storageBucket: "forward-my-mail.firebasestorage.app",
      messagingSenderId: "933044287958",
      appId: "1:933044287958:web:fa3a707dbec62b24e74c77",
      measurementId: "G-J8M65WQCGH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); setPersistence(auth, browserSessionPersistence);
    const db = getFirestore(app);

    const stripe = Stripe('pk_live_51SjjoBPI7rl1q0GXBd6V8O5wp3ha0Kz7BtYGq1unqPQspEBE5Lbrgwxy8WIlgWjP7anr5sI7MbyCkajpscTsAEhh00I7bE4RsM');

    const loginSection = document.getElementById('loginSection');
    const portalSection = document.getElementById('portalSection');
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const userName = document.getElementById('userName');
    const creditBalance = document.getElementById('creditBalance');
    const lowBalanceWarning = document.getElementById('lowBalanceWarning');
    const mailItemsList = document.getElementById('mailItemsList');

    const gateOverlay = document.getElementById('gateOverlay');
    const gateBadge = document.getElementById('gateBadge');

    let currentUser = null;
    let unsubCustomer = null;

    function showError(msg){ errorMessage.textContent = msg; errorMessage.classList.add('show'); setTimeout(()=>errorMessage.classList.remove('show'), 5000); }
    function showSuccess(msg){ successMessage.textContent = msg; successMessage.classList.add('show'); setTimeout(()=>successMessage.classList.remove('show'), 5000); }

    window.addEventListener('load', ()=>{ document.getElementById('email').value=''; document.getElementById('password').value=''; });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await user.getIdToken(true);
        await loadCustomer();
        loginSection.classList.remove('active');
        portalSection.classList.add('active');
      } else {
        currentUser = null;
        loginSection.classList.add('active');
        portalSection.classList.remove('active');
        if (unsubCustomer) unsubCustomer();
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        loginBtn.disabled = true; loginBtn.textContent = 'Logging in...';
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){ showError('Invalid email or password: ' + err.message); }
      finally { loginBtn.disabled = false; loginBtn.textContent = 'Login'; }
    });

    logoutBtn.addEventListener('click', async () => { try{ await signOut(auth); }catch(e){ showError('Error logging out'); } });

    async function loadCustomer(){
      const ref = doc(db,'customers', currentUser.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        userName.textContent = currentUser.email || 'Customer';
        creditBalance.textContent = '0.00';
        showError('Your customer account is not set up yet. Please contact support.');
        return;
      }
      const data = snap.data();
      userName.textContent = data.name || currentUser.email || 'Customer';
      document.getElementById('portalTitle').textContent = (data.name || 'Customer') + "'s Portal";
      creditBalance.textContent = (data.credits || 0).toFixed(2);
      refreshBanner(data);
      gateIfNeeded(data);

      if (unsubCustomer) unsubCustomer();
      unsubCustomer = onSnapshot(ref, (live) => {
        if (!live.exists()) return;
        const d = live.data();
        creditBalance.textContent = (d.credits || 0).toFixed(2);
        refreshBanner(d);
        gateIfNeeded(d);
      });

      await loadMailItems();
    }

    function refreshBanner(data){
      const credits = Number(data.credits || 0);
      const free = Number(data.freeScansRemaining || 0);
      lowBalanceWarning.classList.remove('show');
      lowBalanceWarning.className = 'low-balance-warning';
      if (credits <= 0 && free <= 0) {
        lowBalanceWarning.className = 'critical-credit-warning show';
        lowBalanceWarning.innerHTML = '‚õî <strong>CRITICAL:</strong> You have no credits and no free scans. Please purchase credits.';
      } else if (free > 0) {
        lowBalanceWarning.className = 'low-balance-warning show';
        lowBalanceWarning.innerHTML = `‚úÖ <strong>Free scans available:</strong> ${free} left this month. We‚Äôll use these before your paid credits.`;
      } else if (credits < 5) {
        lowBalanceWarning.className = 'low-balance-warning show';
        lowBalanceWarning.innerHTML = '‚ö†Ô∏è Low credit balance. Please purchase more credits to continue receiving mail scans.';
      }
    }

    // Gate portal interactions if ID required and not approved
    function gateIfNeeded(data){
      const gated = Boolean(data.idRequired) && String(data.idStatus || 'pending') !== 'approved';
      gateOverlay.style.display = gated ? 'flex' : 'none';
      gateBadge.style.display = gated ? 'block' : 'none';
    }

    async function loadMailItems(){
      const q = query(collection(db,'mailItems'),
        where('customerId','==', currentUser.uid),
        orderBy('processedAt','desc'),
        limit(10)
      );
      const qs = await getDocs(q);
      if (qs.empty){
        mailItemsList.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No recent mail items</p>';
        return;
      }
      let html = '';
      qs.forEach(s => {
        const it = s.data();
        const date = it.processedAt?.toDate().toLocaleDateString() || 'Unknown';
        const files = it.files || [];
        let filesHtml = '';
        if (files.length){
          filesHtml = '<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e0e0e0;">';
          files.forEach(f=>{
            const icon = f.type?.includes('pdf') ? 'üìÑ' : 'üñºÔ∏è';
            filesHtml += `<div style="margin-top:5px;"><a href="${f.url}" target="_blank" download="${f.name}" style="color:#1e3c72;text-decoration:none;font-size:14px;display:inline-flex;gap:5px;align-items:center;">${icon} ${f.name} <span style="color:#999;font-size:12px;">(${(f.size/1024/1024).toFixed(2)} MB)</span></a></div>`;
          });
          filesHtml += '</div>';
        }
        html += `
          <div class="mail-item">
            <div class="mail-item-info">
              <div><strong>${it.pages || 1} page(s)</strong></div>
              <div class="mail-item-date">${date}</div>
              ${it.notes ? `<div style="color:#666;font-size:14px;margin-top:5px;">${it.notes}</div>` : ''}
              ${filesHtml}
            </div>
            <div style="text-align:right;">
              <span class="mail-item-status status-${it.status || 'scanned'}">${it.status || 'scanned'}</span>
              <div style="margin-top:5px;font-weight:bold;color:#1e3c72;">¬£${it.cost?.toFixed(2) || '0.00'}</div>
            </div>
          </div>`;
      });
      mailItemsList.innerHTML = html;
    }

    // Stripe credit purchases
    document.querySelectorAll('.credit-pack').forEach(pack=>{
      pack.addEventListener('click', async ()=>{
        const amount = parseInt(pack.dataset.amount, 10);
        try{
          pack.style.opacity='0.5'; pack.style.pointerEvents='none';
          const res = await fetch('https://createcheckoutsession-yr34k57gsq-uc.a.run.app',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ amount, customerId: currentUser.uid, customerEmail: currentUser.email })
          });
          const session = await res.json();
          const result = await stripe.redirectToCheckout({ sessionId: session.id });
          if (result.error) showError(result.error.message);
        }catch(err){ showError('Failed to initiate payment. Please try again.'); }
        finally{ pack.style.opacity='1'; pack.style.pointerEvents='auto'; }
      });
    });
  </script>
</body>
</html>
